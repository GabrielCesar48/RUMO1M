{% extends 'base.html' %}

{% block title %}Adicionar Lan√ßamentos - RUMO1M{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .page-header h1 {
        font-family: var(--font-display);
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--gray-900);
        margin-bottom: 0.5rem;
    }
    
    .page-header p {
        color: var(--gray-600);
        font-size: 1.125rem;
    }
    
    /* Indicador de Saldo */
    .saldo-indicator {
        background: var(--white);
        border-radius: var(--radius-2xl);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
        text-align: center;
        transition: all var(--transition-base);
        border: 3px solid transparent;
    }
    
    .saldo-positivo {
        border-color: var(--secondary);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
    }
    
    .saldo-neutro {
        border-color: var(--accent);
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
    }
    
    .saldo-negativo {
        border-color: var(--danger);
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
    }
    
    .saldo-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }
    
    .saldo-valor {
        font-size: 3rem;
        font-weight: 800;
        font-family: var(--font-display);
        margin-bottom: 0.5rem;
    }
    
    .saldo-positivo .saldo-valor { color: var(--secondary); }
    .saldo-neutro .saldo-valor { color: var(--accent); }
    .saldo-negativo .saldo-valor { color: var(--danger); }
    
    .saldo-status {
        font-size: 1rem;
        font-weight: 500;
        color: var(--gray-700);
    }
    
    /* Card Principal */
    .main-card {
        background: var(--white);
        border-radius: var(--radius-2xl);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
    }
    
    .main-card h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    /* Bot√µes de Opera√ß√£o */
    .operation-toggle {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .operation-btn {
        padding: 1.25rem;
        border-radius: var(--radius-xl);
        border: 3px solid var(--gray-200);
        background: var(--white);
        cursor: pointer;
        transition: all var(--transition-base);
        font-weight: 600;
        font-size: 1.125rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
    }
    
    .operation-btn:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
    }
    
    .operation-btn.active {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: var(--white);
        border-color: var(--primary);
    }
    
    .operation-btn.active.venda {
        background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        border-color: var(--danger);
    }
    
    /* Form Groups */
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .form-control, .form-select {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        font-size: 1rem;
        font-family: var(--font-primary);
        transition: all var(--transition-base);
        background: var(--gray-50);
    }
    
    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: var(--primary);
        background: var(--white);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    /* Autocomplete */
    .autocomplete-wrapper {
        position: relative;
    }
    
    .autocomplete-results {
        position: absolute;
        top: calc(100% + 0.5rem);
        left: 0;
        right: 0;
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .autocomplete-results.active {
        display: block;
    }
    
    .autocomplete-item {
        padding: 1rem 1.25rem;
        cursor: pointer;
        transition: background var(--transition-fast);
        border-bottom: 1px solid var(--gray-100);
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .autocomplete-item:hover {
        background: var(--gray-50);
    }
    
    .autocomplete-item strong {
        color: var(--primary);
        font-weight: 700;
    }
    
    /* Input Group */
    .input-group {
        display: flex;
        gap: 0;
    }
    
    .input-group-text {
        background: var(--gray-100);
        border: 2px solid var(--gray-200);
        border-right: none;
        padding: 0.875rem 1rem;
        border-radius: var(--radius-lg) 0 0 var(--radius-lg);
        font-weight: 600;
        color: var(--gray-700);
    }
    
    .input-group .form-control {
        border-left: none;
        border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
    }
    
    .input-group:focus-within .input-group-text {
        border-color: var(--primary);
        background: var(--primary-light);
        color: var(--white);
    }
    
    /* Grid de Campos */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    /* Bot√µes */
    .btn {
        padding: 0.875rem 2rem;
        border-radius: var(--radius-lg);
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all var(--transition-base);
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: var(--white);
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        width: 100%;
    }
    
    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }
    
    .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .btn-success {
        background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
        color: var(--white);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        width: 100%;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }
    
    .btn-secondary {
        background: var(--gray-200);
        color: var(--gray-700);
        width: 100%;
    }
    
    .btn-secondary:hover {
        background: var(--gray-300);
    }
    
    /* Lista de Lan√ßamentos */
    .lancamentos-list {
        display: none;
        margin-top: 2rem;
    }
    
    .lancamentos-list.active {
        display: block;
    }
    
    .lancamentos-list h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 1rem;
    }
    
    .lancamento-item {
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 4px solid var(--secondary);
        transition: all var(--transition-fast);
    }
    
    .lancamento-item:hover {
        background: var(--gray-100);
        transform: translateX(4px);
    }
    
    .lancamento-item.venda {
        border-left-color: var(--danger);
    }
    
    .lancamento-info strong {
        color: var(--gray-900);
        display: block;
        margin-bottom: 0.25rem;
    }
    
    .lancamento-info small {
        color: var(--gray-600);
        font-size: 0.875rem;
    }
    
    .btn-remove {
        background: var(--danger);
        color: var(--white);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: var(--radius);
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: 0.875rem;
    }
    
    .btn-remove:hover {
        background: #dc2626;
        transform: scale(1.05);
    }
    
    @media (max-width: 767px) {
        .page-header h1 { font-size: 2rem; }
        .saldo-valor { font-size: 2rem; }
        .form-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}

<div class="page-header">
    <h1>üí∞ Adicionar Lan√ßamentos</h1>
    <p>Registre suas compras e vendas de ativos</p>
</div>

<div style="max-width: 900px; margin: 0 auto;">
    {% csrf_token %}
    
    <!-- Indicador de Saldo -->
    <div id="saldoIndicator" class="saldo-indicator saldo-neutro">
        <div class="saldo-label" id="statusSaldo">Faltam investir</div>
        <div class="saldo-valor" id="saldoValor">R$ {{ proximo_valor|floatformat:2|default:"0,00" }}</div>
        <div class="saldo-status">
            <i class="bi bi-info-circle"></i>
            Valor corrigido pela infla√ß√£o
        </div>
    </div>
    
    <!-- Card Principal -->
    <div class="main-card">
        <h2>
            <i class="bi bi-plus-circle"></i>
            Nova Opera√ß√£o
        </h2>
        
        <!-- Tipo de Opera√ß√£o -->
        <div class="operation-toggle">
            <button class="operation-btn active" data-operation="COMPRA">
                <i class="bi bi-cart-plus"></i>
                Compra
            </button>
            <button class="operation-btn venda" data-operation="VENDA">
                <i class="bi bi-cart-dash"></i>
                Venda
            </button>
        </div>
        
        <!-- Tipo de Ativo -->
        <div class="form-group">
            <label class="form-label">Tipo de Ativo</label>
            <select id="tipoAtivo" class="form-select">
                <option value="">Selecione o tipo</option>
                <option value="ACOES">üìà A√ß√µes</option>
                <option value="FIIS">üè¢ FIIs</option>
                <option value="BDRS">üåç BDRs</option>
                <option value="ETFS">üìä ETFs</option>
                <option value="FUNDOS">üíº Fundos de Investimento</option>
                <option value="CRIPTOMOEDAS">‚Çø Criptomoedas</option>
                <option value="TESOURO">üèõÔ∏è Tesouro Direto</option>
                <option value="RENDA_FIXA">üíµ Renda Fixa (CDB/LCI/LCA)</option>
                <option value="OUTROS">üì¶ Outros</option>
            </select>
        </div>
        
        <!-- Campos Din√¢micos -->
        <div id="camposAtivo"></div>
        
        <!-- Bot√£o Adicionar -->
        <button type="button" id="btnAdicionar" class="btn btn-primary" disabled>
            <i class="bi bi-plus-lg"></i>
            Adicionar √† Lista
        </button>
        
        <!-- Lista de Lan√ßamentos -->
        <div id="listaLancamentos" class="lancamentos-list">
            <h3>Lan√ßamentos a Salvar:</h3>
            <div id="lancamentosContainer"></div>
            
            <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" id="btnSalvar" class="btn btn-success">
                    <i class="bi bi-check2-circle"></i>
                    Salvar Todos os Lan√ßamentos
                </button>
                <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                    <i class="bi bi-x-lg"></i>
                    Cancelar
                </a>
            </div>
        </div>
    </div>
    
</div>

{% endblock %}

{% block extra_js %}
<script>
// Estado global
const state = {
    saldoInicial: parseFloat('{{ proximo_valor|default:0 }}'),
    saldoRestante: parseFloat('{{ proximo_valor|default:0 }}'),
    lancamentos: [],
    tipoOperacao: 'COMPRA',
    autocompleteTimeout: null
};

// Toggle Opera√ß√£o
document.querySelectorAll('.operation-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.operation-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        state.tipoOperacao = this.dataset.operation;
    });
});

// Atualizar Saldo
function atualizarSaldo() {
    const indicator = document.getElementById('saldoIndicator');
    const valorEl = document.getElementById('saldoValor');
    const statusEl = document.getElementById('statusSaldo');
    
    const saldo = state.saldoRestante;
    const valorAbsoluto = Math.abs(saldo);
    
    valorEl.textContent = 'R$ ' + valorAbsoluto.toFixed(2).replace('.', ',');
    
    indicator.className = 'saldo-indicator';
    
    if (saldo > 50) {
        indicator.classList.add('saldo-neutro');
        statusEl.textContent = 'Faltam investir';
    } else if (saldo >= -50 && saldo <= 50) {
        indicator.classList.add('saldo-positivo');
        statusEl.textContent = 'Objetivo atingido! ‚úÖ';
    } else {
        indicator.classList.add('saldo-negativo');
        statusEl.textContent = 'Investiu a mais';
    }
}

// Tipo de Ativo Change
document.getElementById('tipoAtivo').addEventListener('change', function(e) {
    gerarCampos(e.target.value);
});

function gerarCampos(tipo) {
    const container = document.getElementById('camposAtivo');
    container.innerHTML = '';
    
    if (!tipo) {
        document.getElementById('btnAdicionar').disabled = true;
        return;
    }
    
    const usaAPI = ['ACOES', 'FUNDOS', 'FIIS', 'CRIPTOMOEDAS', 'BDRS', 'ETFS'].includes(tipo);
    let html = '';
    
    if (usaAPI) {
        html = `
            <div class="form-group autocomplete-wrapper">
                <label class="form-label">Buscar Ativo</label>
                <input type="text" id="inputBusca" class="form-control" placeholder="Digite o ticker ou nome...">
                <div id="autocompleteResults" class="autocomplete-results"></div>
                <input type="hidden" id="tickerSelecionado">
            </div>
            <div class="form-group">
                <label class="form-label">Nome do Ativo</label>
                <input type="text" id="nomeAtivo" class="form-control" readonly>
            </div>
        `;
    } else if (tipo === 'TESOURO') {
        html = `
            <div class="form-group">
                <label class="form-label">Nome do T√≠tulo</label>
                <input type="text" id="nomeAtivo" class="form-control" placeholder="Ex: Tesouro Selic 2029">
            </div>
        `;
    } else if (tipo === 'RENDA_FIXA') {
        html = `
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Emissor</label>
                    <input type="text" id="emissor" class="form-control" placeholder="Ex: Banco Inter">
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de T√≠tulo</label>
                    <select id="tipoRendaFixa" class="form-select">
                        <option value="">Selecionar</option>
                        <option value="CDB">CDB</option>
                        <option value="LCI">LCI</option>
                        <option value="LCA">LCA</option>
                        <option value="LC">LC</option>
                        <option value="LF">LF</option>
                        <option value="RDB">RDB</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Indexador</label>
                    <select id="indexador" class="form-select">
                        <option value="">Selecionar</option>
                        <option value="CDI">CDI</option>
                        <option value="IPCA">IPCA</option>
                        <option value="PREFIXADO">Prefixado</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Nome do Ativo (opcional)</label>
                <input type="text" id="nomeAtivo" class="form-control" placeholder="Ex: CDB 100% CDI - Banco Inter">
            </div>
        `;
    } else {
        html = `
            <div class="form-group">
                <label class="form-label">Nome do Ativo</label>
                <input type="text" id="nomeAtivo" class="form-control" placeholder="Digite o nome...">
            </div>
        `;
    }
    
    const hoje = new Date().toISOString().split('T')[0];
    const step = tipo === 'CRIPTOMOEDAS' ? '0.00000001' : '1';
    
    html += `
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Data</label>
                <input type="date" id="dataCompra" class="form-control" value="${hoje}">
            </div>
            <div class="form-group">
                <label class="form-label">Quantidade</label>
                <input type="number" id="quantidade" class="form-control" step="${step}" min="0" placeholder="0">
            </div>
            <div class="form-group">
                <label class="form-label">Pre√ßo (R$)</label>
                <input type="number" id="preco" class="form-control" step="0.01" min="0" placeholder="0.00">
            </div>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Outros Custos (R$)</label>
                <input type="number" id="custos" class="form-control" step="0.01" min="0" value="0">
            </div>
            <div class="form-group">
                <label class="form-label">Valor Total</label>
                <input type="text" id="valorTotal" class="form-control" readonly style="background: var(--gray-100); font-weight: 700;">
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    if (usaAPI) setupAutocomplete();
    setupCalculos();
    
    document.getElementById('btnAdicionar').disabled = false;
}

function setupAutocomplete() {
    const input = document.getElementById('inputBusca');
    const results = document.getElementById('autocompleteResults');
    
    input.addEventListener('input', function(e) {
        clearTimeout(state.autocompleteTimeout);
        const query = e.target.value.trim();
        
        if (query.length < 2) {
            results.classList.remove('active');
            return;
        }
        
        state.autocompleteTimeout = setTimeout(async function() {
            const tipo = document.getElementById('tipoAtivo').value;
            const url = '/investments/api/buscar-ativos/?q=' + encodeURIComponent(query) + '&tipo=' + tipo;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.resultados && data.resultados.length > 0) {
                    results.innerHTML = data.resultados.map(r => `
                        <div class="autocomplete-item" data-ticker="${r.ticker}" data-nome="${r.nome}">
                            <strong>${r.ticker}</strong> - ${r.nome}
                        </div>
                    `).join('');
                    results.classList.add('active');
                    
                    document.querySelectorAll('.autocomplete-item').forEach(item => {
                        item.addEventListener('click', function() {
                            selecionarAtivo(this.dataset.ticker, this.dataset.nome);
                        });
                    });
                } else {
                    results.classList.remove('active');
                }
            } catch (error) {
                console.error('Erro ao buscar:', error);
            }
        }, 300);
    });
}

async function selecionarAtivo(ticker, nome) {
    document.getElementById('tickerSelecionado').value = ticker;
    document.getElementById('nomeAtivo').value = nome;
    document.getElementById('inputBusca').value = ticker;
    document.getElementById('autocompleteResults').classList.remove('active');
    
    try {
        const response = await fetch('/investments/api/buscar-cotacao/?ticker=' + encodeURIComponent(ticker));
        if (response.ok) {
            const data = await response.json();
            if (data.preco && data.preco > 0) {
                document.getElementById('preco').value = data.preco.toFixed(2);
                calcularTotal();
            }
        }
    } catch (error) {
        console.error('Erro ao buscar cota√ß√£o:', error);
    }
}

function setupCalculos() {
    ['quantidade', 'preco', 'custos'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', calcularTotal);
    });
}

function calcularTotal() {
    const qtd = parseFloat(document.getElementById('quantidade').value) || 0;
    const preco = parseFloat(document.getElementById('preco').value) || 0;
    const custos = parseFloat(document.getElementById('custos').value) || 0;
    const total = (qtd * preco) + custos;
    document.getElementById('valorTotal').value = 'R$ ' + total.toFixed(2).replace('.', ',');
}

// Adicionar Lan√ßamento
document.getElementById('btnAdicionar').addEventListener('click', function() {
    const tipo = document.getElementById('tipoAtivo').value;
    const nomeAtivoEl = document.getElementById('nomeAtivo');
    const qtdEl = document.getElementById('quantidade');
    const precoEl = document.getElementById('preco');
    
    if (!nomeAtivoEl || !qtdEl || !precoEl || !nomeAtivoEl.value.trim() || !qtdEl.value || !precoEl.value) {
        alert('Preencha todos os campos obrigat√≥rios!');
        return;
    }
    
    if (tipo === 'RENDA_FIXA') {
        const emissorEl = document.getElementById('emissor');
        const tipoRendaFixaEl = document.getElementById('tipoRendaFixa');
        const indexadorEl = document.getElementById('indexador');
        
        if (!emissorEl?.value.trim() || !tipoRendaFixaEl?.value || !indexadorEl?.value) {
            alert('Preencha todos os campos de Renda Fixa!');
            return;
        }
    }
    
    const lancamento = {
        tipo_operacao: state.tipoOperacao,
        tipo_ativo: tipo,
        ticker: document.getElementById('tickerSelecionado')?.value || '',
        nome_ativo: nomeAtivoEl.value,
        data: document.getElementById('dataCompra').value,
        quantidade: parseFloat(qtdEl.value),
        preco: parseFloat(precoEl.value),
        custos: parseFloat(document.getElementById('custos').value) || 0,
        total: (parseFloat(qtdEl.value) * parseFloat(precoEl.value)) + (parseFloat(document.getElementById('custos').value) || 0),
        emissor: document.getElementById('emissor')?.value || '',
        tipo_renda_fixa: document.getElementById('tipoRendaFixa')?.value || '',
        indexador: document.getElementById('indexador')?.value || '',
        data_vencimento: document.getElementById('dataVencimento')?.value || null,
        liquidez_diaria: document.getElementById('liquidezDiaria')?.checked || false
    };
    
    state.lancamentos.push(lancamento);
    
    if (state.tipoOperacao === 'COMPRA') {
        state.saldoRestante -= lancamento.total;
    } else {
        state.saldoRestante += lancamento.total;
    }
    
    atualizarSaldo();
    renderizarLancamentos();
    limparFormulario();
});

function renderizarLancamentos() {
    const container = document.getElementById('lancamentosContainer');
    const lista = document.getElementById('listaLancamentos');
    
    if (state.lancamentos.length === 0) {
        lista.classList.remove('active');
        return;
    }
    
    lista.classList.add('active');
    
    container.innerHTML = state.lancamentos.map((l, i) => {
        const emoji = l.tipo_operacao === 'COMPRA' ? 'üü¢' : 'üî¥';
        const classe = l.tipo_operacao.toLowerCase();
        return `
            <div class="lancamento-item ${classe}">
                <div class="lancamento-info">
                    <strong>${emoji} ${l.nome_ativo}</strong>
                    <small>${l.quantidade} x R$ ${l.preco.toFixed(2)} = R$ ${l.total.toFixed(2)}</small>
                </div>
                <button class="btn-remove" onclick="removerLancamento(${i})">
                    <i class="bi bi-trash"></i> Remover
                </button>
            </div>
        `;
    }).join('');
}

function removerLancamento(index) {
    const lanc = state.lancamentos[index];
    
    if (lanc.tipo_operacao === 'COMPRA') {
        state.saldoRestante += lanc.total;
    } else {
        state.saldoRestante -= lanc.total;
    }
    
    state.lancamentos.splice(index, 1);
    atualizarSaldo();
    renderizarLancamentos();
}

function limparFormulario() {
    document.getElementById('tipoAtivo').value = '';
    document.getElementById('camposAtivo').innerHTML = '';
    document.getElementById('btnAdicionar').disabled = true;
}

// Salvar Todos
document.getElementById('btnSalvar').addEventListener('click', async function() {
    if (state.lancamentos.length === 0) {
        alert('Adicione pelo menos um lan√ßamento!');
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    try {
        const response = await fetch('/investments/api/salvar-lancamentos/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ lancamentos: state.lancamentos })
        });
        
        const data = await response.json();
        
        if (data.sucesso) {
            window.location.href = "{% url 'dashboard' %}";
        } else {
            alert('Erro ao salvar: ' + (data.erro || 'Erro desconhecido'));
        }
    } catch (error) {
        alert('Erro ao salvar: ' + error.message);
    }
});
</script>
{% endblock %}