{% extends 'base.html' %}

{% block title %}An√°lise Fundamentalista - Rumo1M{% endblock %}

{% block extra_css %}
<style>
    /* ============================================================
       PALETA DE CORES MODERNA E PROFISSIONAL
       ============================================================ */
    :root {
        --bg-primary: #f8fafc;
        --bg-secondary: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --text-muted: #94a3b8;
        
        --accent-blue: #3b82f6;
        --accent-success: #10b981;
        --accent-warning: #f59e0b;
        --accent-danger: #ef4444;
        
        --border-color: #e2e8f0;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    /* ============================================================
       LAYOUT GERAL
       ============================================================ */
    body {
        background: var(--bg-primary);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .valuation-container {
        max-width: 1400px;
        padding: 20px;
    }
    
    /* ============================================================
       HEADER
       ============================================================ */
    .page-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 40px 20px;
        background: var(--bg-secondary);
        border-radius: 24px;
        box-shadow: var(--shadow-md);
    }
    
    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 10px;
    }
    
    .page-header p {
        font-size: 1.1rem;
        color: var(--text-secondary);
        margin: 0;
    }
    
    /* ============================================================
       SE√á√ÉO DE BUSCA
       ============================================================ */
    .search-section {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 30px;
        box-shadow: var(--shadow-md);
        margin-bottom: 30px;
    }
    
    .search-input-wrapper {
        position: relative;
        max-width: 600px;
        margin: 0 auto;
    }
    
    .search-input {
        width: 100%;
        padding: 16px 50px 16px 20px;
        font-size: 1.1rem;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        transition: all 0.3s;
        background: var(--bg-primary);
    }
    
    .search-input:focus {
        outline: none;
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }
    
    .search-icon {
        position: absolute;
        right: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 1.3rem;
    }
    
    /* Autocomplete */
    .autocomplete-list {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: var(--shadow-lg);
        display: none;
    }
    
    .autocomplete-list.active {
        display: block;
    }
    
    .autocomplete-item {
        padding: 14px 18px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid var(--border-color);
    }
    
    .autocomplete-item:hover {
        background: var(--bg-primary);
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .autocomplete-item strong {
        color: var(--accent-blue);
        font-weight: 600;
    }
    
    /* ============================================================
       RESULTADO - LAYOUT
       ============================================================ */
    .resultado-section {
        display: none;
    }
    
    .resultado-section.active {
        display: block;
        animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* ============================================================
       HEADER DA A√á√ÉO
       ============================================================ */
    .stock-header {
        background: var(--gradient-primary);
        color: white;
        border-radius: 24px;
        padding: 40px;
        margin-bottom: 30px;
        box-shadow: var(--shadow-lg);
    }
    
    .stock-header h1 {
        font-size: 3rem;
        font-weight: 800;
        margin: 0 0 10px 0;
    }
    
    .stock-price {
        font-size: 2rem;
        font-weight: 600;
        opacity: 0.95;
    }
    
    /* ============================================================
       DADOS FUNDAMENTALISTAS
       ============================================================ */
    .fundamentals-card {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 30px;
        box-shadow: var(--shadow-md);
        margin-bottom: 30px;
    }
    
    .fundamentals-card h5 {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 25px;
    }
    
    .fundamentals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
    }
    
    .fundamental-item {
        text-align: center;
        padding: 20px;
        background: var(--bg-primary);
        border-radius: 12px;
        transition: transform 0.2s;
    }
    
    .fundamental-item:hover {
        transform: translateY(-4px);
    }
    
    .fundamental-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }
    
    .fundamental-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .fundamental-subtitle {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 4px;
    }
    
    /* ============================================================
       AN√ÅLISE DA IA ESPECIALISTA
       ============================================================ */
    .ai-analysis-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        padding: 35px;
        box-shadow: var(--shadow-lg);
        margin-bottom: 30px;
    }
    
    .ai-analysis-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .ai-analysis-header i {
        font-size: 2.5rem;
    }
    
    .ai-analysis-header h5 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }
    
    .ai-analysis-content {
        font-size: 1.05rem;
        line-height: 1.7;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 25px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* ============================================================
       NOT√çCIAS
       ============================================================ */
    .news-card {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 30px;
        box-shadow: var(--shadow-md);
        margin-bottom: 30px;
    }
    
    .news-card h5 {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 20px;
    }
    
    .news-content {
        font-size: 1rem;
        line-height: 1.7;
        color: var(--text-secondary);
        padding: 20px;
        background: var(--bg-primary);
        border-radius: 12px;
        border-left: 4px solid var(--accent-blue);
    }
    
    /* ============================================================
       RECOMENDA√á√ÉO GERAL
       ============================================================ */
    .recommendation-card {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 40px;
        box-shadow: var(--shadow-lg);
        text-align: center;
        margin-bottom: 30px;
    }
    
    .recommendation-status {
        font-size: 3rem;
        font-weight: 900;
        margin: 20px 0;
    }
    
    .recommendation-status.comprar {
        color: var(--accent-success);
    }
    
    .recommendation-status.vender {
        color: var(--accent-danger);
    }
    
    .recommendation-status.aguardar {
        color: var(--accent-warning);
    }
    
    .recommendation-votes {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-top: 25px;
    }
    
    .vote-item {
        text-align: center;
    }
    
    .vote-number {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--accent-blue);
    }
    
    .vote-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-top: 5px;
    }
    
    /* ============================================================
       M√âTODOS - GRID
       ============================================================ */
    .methods-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .method-card {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 30px;
        box-shadow: var(--shadow-md);
        border: 2px solid transparent;
        transition: all 0.3s;
    }
    
    .method-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }
    
    .method-card.comprar {
        border-color: var(--accent-success);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);
    }
    
    .method-card.vender {
        border-color: var(--accent-danger);
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.02) 100%);
    }
    
    .method-card.aguardar {
        border-color: var(--accent-warning);
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(245, 158, 11, 0.02) 100%);
    }
    
    .method-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
    }
    
    .method-emoji {
        font-size: 2rem;
    }
    
    .method-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }
    
    .method-description {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 20px;
    }
    
    .method-price {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--accent-blue);
        margin-bottom: 15px;
        padding: 15px;
        background: rgba(59, 130, 246, 0.1);
        border-radius: 10px;
        text-align: center;
    }
    
    .method-formula {
        font-size: 0.85rem;
        color: var(--text-muted);
        padding: 12px;
        background: var(--bg-primary);
        border-radius: 8px;
        margin-bottom: 15px;
        font-family: 'Monaco', 'Courier New', monospace;
    }
    
    .method-margin {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: rgba(59, 130, 246, 0.1);
        border-radius: 8px;
        margin-bottom: 15px;
    }
    
    .method-margin-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    
    .method-margin-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--accent-blue);
    }
    
    .method-status {
        padding: 14px;
        border-radius: 10px;
        text-align: center;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .method-status.comprar {
        background: var(--gradient-success);
        color: white;
    }
    
    .method-status.vender {
        background: var(--gradient-danger);
        color: white;
    }
    
    .method-status.aguardar {
        background: var(--gradient-warning);
        color: white;
    }
    
    /* ============================================================
       LOADING & ERRO
       ============================================================ */
    .loading-container {
        text-align: center;
        padding: 60px 20px;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--border-color);
        border-top-color: var(--accent-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .loading-text {
        font-size: 1.1rem;
        color: var(--text-secondary);
    }
    
    .error-card {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%);
        border-left: 4px solid var(--accent-danger);
        color: var(--accent-danger);
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    
    /* ============================================================
       EXPLICA√á√ïES
       ============================================================ */
    .info-card {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: 30px;
        box-shadow: var(--shadow-md);
    }
    
    .info-card h5 {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 20px;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .info-item h6 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 8px;
    }
    
    .info-item.success h6 { color: var(--accent-success); }
    .info-item.warning h6 { color: var(--accent-warning); }
    .info-item.danger h6 { color: var(--accent-danger); }
    
    .info-item p {
        font-size: 0.9rem;
        color: var(--text-secondary);
        line-height: 1.6;
    }
    
    /* ============================================================
       RESPONSIVO
       ============================================================ */
    @media (max-width: 768px) {
        .page-header h1 {
            font-size: 1.8rem;
        }
        
        .stock-header h1 {
            font-size: 2rem;
        }
        
        .stock-price {
            font-size: 1.5rem;
        }
        
        .methods-grid {
            grid-template-columns: 1fr;
        }
        
        .fundamentals-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .recommendation-status {
            font-size: 2rem;
        }
        
        .recommendation-votes {
            gap: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="valuation-container">
    
    <!-- Header -->
    <div class="page-header">
        <h1>üìä An√°lise Fundamentalista</h1>
        <p>Valuation profissional com 3 metodologias + An√°lise IA + Not√≠cias</p>
    </div>

    <!-- Busca -->
    <div class="search-section">
        <div class="search-input-wrapper">
            <input 
                type="text" 
                id="inputBusca" 
                class="search-input" 
                placeholder="Digite o ticker da a√ß√£o (ex: PETR4, VALE3, ITUB4)..."
                autocomplete="off">
            <i class="bi bi-search search-icon"></i>
            <div id="autocompleteList" class="autocomplete-list"></div>
        </div>
    </div>

    <!-- Resultado -->
    <div id="resultadoSection" class="resultado-section">
        
        <!-- Erro -->
        <div id="erroDiv" style="display: none;" class="error-card"></div>
        
        <!-- Loading -->
        <div id="loadingDiv" style="display: none;" class="loading-container">
            <div class="loading-spinner"></div>
            <p class="loading-text">Analisando a√ß√£o e buscando not√≠cias...</p>
        </div>
        
        <!-- Conte√∫do -->
        <div id="conteudoResultado" style="display: none;">
            
            <!-- Header da A√ß√£o -->
            <div class="stock-header">
                <h1 id="resultadoTicker"></h1>
                <div class="stock-price" id="resultadoPreco"></div>
            </div>

            <!-- Dados Fundamentalistas -->
            <div class="fundamentals-card">
                <h5><i class="bi bi-bar-chart-line"></i> Dados Fundamentalistas</h5>
                <div class="fundamentals-grid">
                    <div class="fundamental-item">
                        <div class="fundamental-label">Pre√ßo Atual</div>
                        <div class="fundamental-value" id="dadoPreco">-</div>
                    </div>
                    <div class="fundamental-item">
                        <div class="fundamental-label">LPA (EPS)</div>
                        <div class="fundamental-value" id="dadoEPS">-</div>
                        <div class="fundamental-subtitle">Lucro por A√ß√£o</div>
                    </div>
                    <div class="fundamental-item">
                        <div class="fundamental-label">P/L</div>
                        <div class="fundamental-value" id="dadoPE">-</div>
                        <div class="fundamental-subtitle">Pre√ßo / Lucro</div>
                    </div>
                    <div class="fundamental-item">
                        <div class="fundamental-label">ROE</div>
                        <div class="fundamental-value" id="dadoROE">-</div>
                        <div class="fundamental-subtitle">Retorno s/ PL</div>
                    </div>
                    <div class="fundamental-item">
                        <div class="fundamental-label">Dividend Yield</div>
                        <div class="fundamental-value" id="dadoDY">-</div>
                        <div class="fundamental-subtitle">Dividendos Anuais</div>
                    </div>
                </div>
            </div>

            <!-- An√°lise da IA Especialista -->
            <div class="ai-analysis-card">
                <div class="ai-analysis-header">
                    <i class="bi bi-robot"></i>
                    <h5>An√°lise do Especialista IA</h5>
                </div>
                <div class="ai-analysis-content" id="aiAnalysis">
                    Carregando an√°lise...
                </div>
            </div>

            <!-- Not√≠cias -->
            <div class="news-card">
                <h5><i class="bi bi-newspaper"></i> √öltimas Not√≠cias</h5>
                <div class="news-content" id="newsContent">
                    Carregando not√≠cias...
                </div>
            </div>

            <!-- Recomenda√ß√£o Geral -->
            <div class="recommendation-card">
                <h5>Recomenda√ß√£o Consolidada</h5>
                <div class="recommendation-status" id="statusGeral"></div>
                <div class="recommendation-votes">
                    <div class="vote-item">
                        <div class="vote-number" id="pontosCompra">0</div>
                        <div class="vote-label">M√©todos para COMPRAR</div>
                    </div>
                    <div class="vote-item">
                        <div class="vote-number" id="pontosVenda">0</div>
                        <div class="vote-label">M√©todos para VENDER</div>
                    </div>
                </div>
            </div>

            <!-- M√©todos -->
            <div class="methods-grid">
                
                <!-- BAZIN -->
                <div class="method-card" id="bazinCard">
                    <div class="method-header">
                        <span class="method-emoji" id="bazinEmoji">üü°</span>
                        <h6 class="method-title">M√©todo Bazin</h6>
                    </div>
                    <p class="method-description">Pre√ßo-teto baseado em Dividend Yield (6% a.a.)</p>
                    <div class="method-price" id="bazinPreco">N/A</div>
                    <div class="method-formula" id="bazinFormula">Calculando...</div>
                    <div class="method-margin">
                        <span class="method-margin-label">Margem de Seguran√ßa:</span>
                        <span class="method-margin-value" id="bazinMargem">N/A</span>
                    </div>
                    <div class="method-status" id="bazinStatus">DADOS INSUFICIENTES</div>
                </div>
                
                <!-- GRAHAM -->
                <div class="method-card" id="grahamCard">
                    <div class="method-header">
                        <span class="method-emoji" id="grahamEmoji">üü°</span>
                        <h6 class="method-title">M√©todo Graham</h6>
                    </div>
                    <p class="method-description">Pre√ßo justo usando P/L e VPA</p>
                    <div class="method-price" id="grahamPreco">N/A</div>
                    <div class="method-formula" id="grahamFormula">Calculando...</div>
                    <div class="method-margin">
                        <span class="method-margin-label">Margem de Seguran√ßa:</span>
                        <span class="method-margin-value" id="grahamMargem">N/A</span>
                    </div>
                    <div class="method-status" id="grahamStatus">DADOS INSUFICIENTES</div>
                </div>
                
                <!-- LYNCH -->
                <div class="method-card" id="lynchCard">
                    <div class="method-header">
                        <span class="method-emoji" id="lynchEmoji">üü°</span>
                        <h6 class="method-title">M√©todo Lynch (PEG)</h6>
                    </div>
                    <p class="method-description">P/E Ratio √∑ Taxa de Crescimento (ROE)</p>
                    <div class="method-price">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">PEG Ratio</div>
                        <span id="lynchPeg">N/A</span>
                    </div>
                    <div class="method-formula" id="lynchFormula">Calculando...</div>
                    <div class="method-margin">
                        <span class="method-margin-label">Pre√ßo Ideal:</span>
                        <span class="method-margin-value" id="lynchPreco">N/A</span>
                    </div>
                    <div class="method-status" id="lynchStatus">DADOS INSUFICIENTES</div>
                </div>
                
            </div>

            <!-- Explica√ß√µes -->
            <div class="info-card">
                <h5>üìö Como Interpretar os Resultados</h5>
                <div class="info-grid">
                    <div class="info-item success">
                        <h6><i class="bi bi-check-circle"></i> COMPRAR</h6>
                        <p>A√ß√£o com pre√ßo abaixo do calculado. Boa oportunidade de entrada.</p>
                    </div>
                    <div class="info-item warning">
                        <h6><i class="bi bi-pause-circle"></i> AGUARDAR</h6>
                        <p>Pre√ßo pr√≥ximo ao justo. Aguarde melhor oportunidade.</p>
                    </div>
                    <div class="info-item danger">
                        <h6><i class="bi bi-x-circle"></i> VENDER</h6>
                        <p>A√ß√£o acima do pre√ßo justo. Considere realizar lucro.</p>
                    </div>
                </div>
                <hr style="border-color: var(--border-color); margin: 25px 0;">
                <p style="color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6; margin: 0;">
                    <strong>Bazin:</strong> Ideal para dividendos (DY 6%)  ‚Ä¢  
                    <strong>Graham:</strong> An√°lise fundamental cl√°ssica  ‚Ä¢  
                    <strong>Lynch:</strong> Compara P/L com crescimento (PEG < 1 = subavaliado)
                </p>
            </div>

        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Estado global
const state = {
    timeout: null
};

// ============================================================
// AUTOCOMPLETE
// ============================================================
document.getElementById('inputBusca').addEventListener('input', function(e) {
    clearTimeout(state.timeout);
    const query = e.target.value.trim();
    
    if (query.length < 2) {
        document.getElementById('autocompleteList').classList.remove('active');
        return;
    }
    
    state.timeout = setTimeout(async function() {
        try {
            const response = await fetch('/investments/api/buscar-acoes-valuation/?q=' + encodeURIComponent(query));
            const data = await response.json();
            
            if (data.resultados && data.resultados.length > 0) {
                renderizarAutocomplete(data.resultados);
            } else {
                document.getElementById('autocompleteList').classList.remove('active');
            }
        } catch (error) {
            console.error('Erro ao buscar:', error);
        }
    }, 300);
});

function renderizarAutocomplete(acoes) {
    const list = document.getElementById('autocompleteList');
    
    let html = '';
    for (let acao of acoes) {
        html += `<div class="autocomplete-item" data-ticker="${acao.ticker}">`;
        html += `<strong>${acao.ticker}</strong> - ${acao.nome}`;
        html += `</div>`;
    }
    
    list.innerHTML = html;
    list.classList.add('active');
    
    document.querySelectorAll('.autocomplete-item').forEach(item => {
        item.addEventListener('click', function() {
            selecionarAcao(this.dataset.ticker);
        });
    });
}

function selecionarAcao(ticker) {
    document.getElementById('inputBusca').value = ticker;
    document.getElementById('autocompleteList').classList.remove('active');
    mostrarLoading();
    calcularValuation(ticker);
}

// ============================================================
// CALCULAR VALUATION
// ============================================================
async function calcularValuation(ticker) {
    try {
        const response = await fetch('/investments/api/calcular-valuation/?ticker=' + encodeURIComponent(ticker));
        
        if (!response.ok) {
            const data = await response.json();
            mostrarErro(data.erro || 'Erro ao calcular valuation');
            return;
        }
        
        const data = await response.json();
        renderizarResultado(data.resultado);
        
    } catch (error) {
        console.error('Erro:', error);
        mostrarErro('Erro ao processar an√°lise. Tente novamente.');
    }
}

// ============================================================
// RENDERIZAR RESULTADO
// ============================================================
function renderizarResultado(resultado) {
    // Header
    document.getElementById('resultadoTicker').textContent = resultado.ticker;
    document.getElementById('resultadoPreco').textContent = resultado.preco_atual;
    
    // Dados fundamentalistas
    if (resultado.dados_base) {
        document.getElementById('dadoPreco').textContent = resultado.dados_base.preco;
        document.getElementById('dadoEPS').textContent = resultado.dados_base.lpa;
        document.getElementById('dadoPE').textContent = resultado.dados_base.pl;
        document.getElementById('dadoROE').textContent = resultado.dados_base.roe;
        document.getElementById('dadoDY').textContent = resultado.dados_base.dy;
    }
    
    // An√°lise IA
    document.getElementById('aiAnalysis').textContent = resultado.ai_analysis || 'An√°lise n√£o dispon√≠vel';
    
    // Not√≠cias
    document.getElementById('newsContent').textContent = resultado.news_summary || 'Not√≠cias n√£o dispon√≠veis';
    
    // Recomenda√ß√£o geral
    const statusEl = document.getElementById('statusGeral');
    statusEl.textContent = resultado.recomendacao.emoji + ' ' + resultado.recomendacao.status;
    statusEl.className = 'recommendation-status ' + resultado.recomendacao.status.toLowerCase();
    
    document.getElementById('pontosCompra').textContent = resultado.recomendacao.pontos_compra;
    document.getElementById('pontosVenda').textContent = resultado.recomendacao.pontos_venda;
    
    // M√©todos
    renderizarMetodo('bazin', resultado.bazin);
    renderizarMetodo('graham', resultado.graham);
    renderizarMetodo('lynch', resultado.lynch);
    
    // Mostrar resultado
    document.getElementById('loadingDiv').style.display = 'none';
    document.getElementById('erroDiv').style.display = 'none';
    document.getElementById('conteudoResultado').style.display = 'block';
    document.getElementById('resultadoSection').classList.add('active');
}

function renderizarMetodo(metodo, dados) {
    const card = document.getElementById(metodo + 'Card');
    const emojiEl = document.getElementById(metodo + 'Emoji');
    const precoEl = document.getElementById(metodo + 'Preco');
    const margemEl = document.getElementById(metodo + 'Margem');
    const statusEl = document.getElementById(metodo + 'Status');
    const formulaEl = document.getElementById(metodo + 'Formula');
    
    const statusLower = dados.status.toLowerCase();
    emojiEl.textContent = dados.emoji;
    card.className = 'method-card ' + statusLower;
    
    if (metodo === 'lynch') {
        document.getElementById('lynchPeg').textContent = dados.peg || 'N/A';
        document.getElementById('lynchPreco').textContent = dados.preco_ideal || 'N/A';
    } else {
        const chavePreco = metodo === 'bazin' ? 'preco_teto' : 'preco_justo';
        precoEl.textContent = dados[chavePreco] || 'N/A';
    }
    
    if (dados.formula) {
        formulaEl.innerHTML = '<i class="bi bi-calculator"></i> ' + dados.formula;
    }
    
    margemEl.textContent = dados.margem || 'N/A';
    
    statusEl.textContent = dados.emoji + ' ' + dados.status;
    statusEl.className = 'method-status ' + statusLower;
}

function mostrarLoading() {
    document.getElementById('resultadoSection').classList.add('active');
    document.getElementById('loadingDiv').style.display = 'block';
    document.getElementById('erroDiv').style.display = 'none';
    document.getElementById('conteudoResultado').style.display = 'none';
}

function mostrarErro(mensagem) {
    const erroDiv = document.getElementById('erroDiv');
    erroDiv.textContent = '‚ö†Ô∏è ' + mensagem;
    erroDiv.style.display = 'block';
    
    document.getElementById('resultadoSection').classList.add('active');
    document.getElementById('loadingDiv').style.display = 'none';
    document.getElementById('conteudoResultado').style.display = 'none';
}

// Fechar autocomplete ao clicar fora
document.addEventListener('click', function(e) {
    if (e.target.id !== 'inputBusca') {
        document.getElementById('autocompleteList').classList.remove('active');
    }
});
</script>
{% endblock %}