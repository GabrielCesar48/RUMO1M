{% extends 'base.html' %}

{% block title %}An√°lise de Valuation - Rumo1M{% endblock %}

{% block extra_css %}
<style>
    .valuation-container {
        max-width: 1000px;
    }
    
    .search-section {
        margin-bottom: 30px;
    }
    
    .autocomplete-container {
        position: relative;
        margin-bottom: 20px;
    }
    
    .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 12px 12px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .autocomplete-list.active {
        display: block;
    }
    
    .autocomplete-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.2s;
    }
    
    .autocomplete-item:hover {
        background: #f9fafb;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .autocomplete-item strong {
        color: var(--primary);
        font-weight: 700;
    }
    
    .autocomplete-item small {
        color: #6b7280;
    }
    
    .resultado-section {
        display: none;
        animation: slideIn 0.3s ease-out;
    }
    
    .resultado-section.active {
        display: block;
    }
    
    .header-acao {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        padding: 25px;
        border-radius: 20px;
        margin-bottom: 30px;
    }
    
    .header-acao h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 800;
    }
    
    .header-acao .preco-atual {
        font-size: 1.8rem;
        margin-top: 10px;
        font-weight: 700;
    }
    
    .metodos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metodo-card {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 2px solid transparent;
        transition: transform 0.2s, border-color 0.2s;
    }
    
    .metodo-card:hover {
        transform: translateY(-5px);
    }
    
    .metodo-card.comprar {
        border-color: #10b981;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);
    }
    
    .metodo-card.vender {
        border-color: #ef4444;
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.02) 100%);
    }
    
    .metodo-card.aguardar {
        border-color: #eab308;
        background: linear-gradient(135deg, rgba(234, 179, 8, 0.05) 0%, rgba(234, 179, 8, 0.02) 100%);
    }
    
    .metodo-titulo {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .metodo-descricao {
        font-size: 0.85rem;
        color: #6b7280;
        margin-bottom: 15px;
        line-height: 1.5;
    }
    
    .metodo-dados {
        background: white;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
    }
    
    .dado-linha {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }
    
    .dado-linha:last-child {
        margin-bottom: 0;
    }
    
    .dado-label {
        color: #6b7280;
        font-weight: 500;
    }
    
    .dado-valor {
        font-weight: 700;
        color: var(--primary);
    }
    
    .metodo-preco {
        font-size: 1.3rem;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 12px;
        padding: 12px;
        background: rgba(16, 185, 129, 0.1);
        border-radius: 8px;
        text-align: center;
    }
    
    .metodo-margem {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: rgba(16, 185, 129, 0.1);
        border-radius: 8px;
        margin-bottom: 12px;
    }
    
    .metodo-margem strong {
        color: var(--primary);
    }
    
    .metodo-status {
        padding: 12px;
        border-radius: 8px;
        text-align: center;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .status-comprar {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-vender {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .status-aguardar {
        background: #fef3c7;
        color: #92400e;
    }
    
    .recomendacao-geral {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        text-align: center;
        margin-bottom: 30px;
    }
    
    .recomendacao-status {
        font-size: 2.5rem;
        font-weight: 900;
        margin: 20px 0;
    }
    
    .recomendacao-status.comprar {
        color: #10b981;
    }
    
    .recomendacao-status.vender {
        color: #ef4444;
    }
    
    .recomendacao-status.aguardar {
        color: #eab308;
    }
    
    .recomendacao-explicacao {
        color: #6b7280;
        font-size: 1.1rem;
        margin-bottom: 20px;
    }
    
    .votos-container {
        display: flex;
        justify-content: center;
        gap: 30px;
        flex-wrap: wrap;
    }
    
    .voto-item {
        text-align: center;
    }
    
    .voto-numero {
        font-size: 2rem;
        font-weight: 900;
        color: var(--primary);
    }
    
    .voto-label {
        font-size: 0.9rem;
        color: #6b7280;
        margin-top: 5px;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }
    
    .loading-spinner {
        border: 4px solid #e5e7eb;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .emoji {
        display: inline-block;
        font-size: 1.2em;
    }
    
    .erro-message {
        background: #fee2e2;
        border-left: 4px solid #ef4444;
        color: #991b1b;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
        .header-acao h1 {
            font-size: 1.8rem;
        }
        
        .header-acao .preco-atual {
            font-size: 1.3rem;
        }
        
        .metodos-grid {
            grid-template-columns: 1fr;
        }
        
        .recomendacao-status {
            font-size: 2rem;
        }
        
        .votos-container {
            gap: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="valuation-container">
    <!-- Cabe√ßalho -->
    <div class="mb-4">
        <h1 class="mb-2">
            <i class="bi bi-graph-up-arrow"></i> An√°lise de Valuation
        </h1>
        <p class="text-muted">Compare 3 m√©todos de valuation (Bazin, Graham e Lynch) para tomar decis√µes mais informadas</p>
    </div>

    <!-- Se√ß√£o de Busca -->
    <div class="search-section card p-4 mb-4">
        <h5 class="mb-3">
            <i class="bi bi-search"></i> Buscar A√ß√£o
        </h5>
        
        <div class="autocomplete-container">
            <input type="text" 
                   id="inputBusca" 
                   class="form-control form-control-lg" 
                   placeholder="Digite o ticker ou nome da empresa (ex: PETR4, Vale)...">
            <div id="autocompleteList" class="autocomplete-list"></div>
        </div>
    </div>

    <!-- Se√ß√£o de Resultado (inicialmente oculta) -->
    <div id="resultadoSection" class="resultado-section">
        
        <!-- Erro -->
        <div id="erroDiv" style="display: none;" class="erro-message"></div>
        
        <!-- Loading -->
        <div id="loadingDiv" style="display: none;" class="loading">
            <div class="loading-spinner"></div>
            <p>Calculando valuation...</p>
        </div>
        
        <!-- Resultado -->
        <div id="conteudoResultado" style="display: none;">
            
            <!-- Header da A√ß√£o -->
            <div class="header-acao">
                <h1 id="resultadoTicker"></h1>
                <div class="preco-atual">
                    Pre√ßo Atual: <span id="resultadoPreco"></span>
                </div>
            </div>

            <!-- Recomenda√ß√£o Geral -->
            <div class="recomendacao-geral">
                <div class="recomendacao-explicacao">Recomenda√ß√£o dos m√©todos:</div>
                <div class="recomendacao-status" id="statusGeral"></div>
                
                <div class="votos-container">
                    <div class="voto-item">
                        <div class="voto-numero" id="pontosCompra">0</div>
                        <div class="voto-label">M√©todos para COMPRAR</div>
                    </div>
                    <div class="voto-item">
                        <div class="voto-numero" id="pontosVenda">0</div>
                        <div class="voto-label">M√©todos para VENDER</div>
                    </div>
                </div>
            </div>

            <!-- Cards dos M√©todos -->
            <div class="metodos-grid">
                
                <!-- BAZIN -->
                <div class="metodo-card" id="bazinCard">
                    <div class="metodo-titulo">
                        <span class="emoji" id="bazinEmoji">üü°</span>
                        M√©todo Bazin
                    </div>
                    
                    <div class="metodo-descricao">
                        Pre√ßo-teto baseado em Dividend Yield (DY 6%)
                    </div>
                    
                    <div class="metodo-preco" id="bazinPreco">N/A</div>
                    
                    <div class="metodo-margem">
                        <span class="metodo-label">Margem de Seguran√ßa:</span>
                        <strong id="bazinMargem">N/A</strong>
                    </div>
                    
                    <div class="metodo-status" id="bazinStatus">DADOS INSUFICIENTES</div>
                </div>
                
                <!-- GRAHAM -->
                <div class="metodo-card" id="grahamCard">
                    <div class="metodo-titulo">
                        <span class="emoji" id="grahamEmoji">üü°</span>
                        M√©todo Graham
                    </div>
                    
                    <div class="metodo-descricao">
                        Pre√ßo justo usando P/L (PE 15x)
                    </div>
                    
                    <div class="metodo-preco" id="grahamPreco">N/A</div>
                    
                    <div class="metodo-margem">
                        <span class="metodo-label">Margem de Seguran√ßa:</span>
                        <strong id="grahamMargem">N/A</strong>
                    </div>
                    
                    <div class="metodo-status" id="grahamStatus">DADOS INSUFICIENTES</div>
                </div>
                
                <!-- LYNCH -->
                <div class="metodo-card" id="lynchCard">
                    <div class="metodo-titulo">
                        <span class="emoji" id="lynchEmoji">üü°</span>
                        M√©todo Lynch (PEG)
                    </div>
                    
                    <div class="metodo-descricao">
                        P/E Ratio √∑ Taxa de Crescimento (ROE)
                    </div>
                    
                    <div class="metodo-dados">
                        <div class="dado-linha">
                            <span class="dado-label">PEG Ratio:</span>
                            <span class="dado-valor" id="lynchPeg">N/A</span>
                        </div>
                        <div class="dado-linha">
                            <span class="dado-label">Pre√ßo Ideal:</span>
                            <span class="dado-valor" id="lynchPreco">N/A</span>
                        </div>
                    </div>
                    
                    <div class="metodo-margem">
                        <span class="metodo-label">Margem:</span>
                        <strong id="lynchMargem">N/A</strong>
                    </div>
                    
                    <div class="metodo-status" id="lynchStatus">DADOS INSUFICIENTES</div>
                </div>
                
            </div>

            <!-- Explica√ß√µes -->
            <div class="card p-4 mt-4">
                <h5 class="mb-3">üìö Como Interpretar os Resultados</h5>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <h6 class="text-success">
                            <i class="bi bi-check-circle"></i> COMPRAR
                        </h6>
                        <p class="small">A√ß√£o com pre√ßo abaixo do calculado. Boa oportunidade para iniciar ou aumentar posi√ß√£o.</p>
                    </div>
                    <div class="col-md-4 mb-3">
                        <h6 class="text-warning">
                            <i class="bi bi-pause-circle"></i> AGUARDAR
                        </h6>
                        <p class="small">Pre√ßo pr√≥ximo ao justo. Espere por uma melhor oportunidade de entrada.</p>
                    </div>
                    <div class="col-md-4 mb-3">
                        <h6 class="text-danger">
                            <i class="bi bi-x-circle"></i> VENDER
                        </h6>
                        <p class="small">A√ß√£o acima do pre√ßo considerado justo. Considere reduzir a posi√ß√£o.</p>
                    </div>
                </div>
                
                <hr>
                
                <h6 class="mb-2">Sobre os M√©todos:</h6>
                <p class="small text-muted mb-2">
                    <strong>Bazin:</strong> Ideal para a√ß√µes pagadoras de dividendos. Baseado em Dividend Yield de 6%.
                </p>
                <p class="small text-muted mb-2">
                    <strong>Graham:</strong> M√©todo cl√°ssico de an√°lise fundamental. Usa P/L e ROE.
                </p>
                <p class="small text-muted">
                    <strong>Lynch (PEG):</strong> Compara o P/L com a taxa de crescimento. PEG &lt; 1 = Subavaliado.
                </p>
            </div>

        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
const state = {
    acoes: [],
    resultadoAtual: null,
    timeout: null
};

// ============================================================
// AUTOCOMPLETE
// ============================================================

document.getElementById('inputBusca').addEventListener('input', function(e) {
    clearTimeout(state.timeout);
    const query = e.target.value.trim();
    
    if (query.length < 1) {
        document.getElementById('autocompleteList').classList.remove('active');
        return;
    }
    
    state.timeout = setTimeout(async function() {
        try {
            const response = await fetch(
                '/investments/api/buscar-acoes-valuation/?q=' + encodeURIComponent(query)
            );
            const data = await response.json();
            
            if (data.resultados && data.resultados.length > 0) {
                renderizarAutocomplete(data.resultados);
            } else {
                document.getElementById('autocompleteList').classList.remove('active');
            }
        } catch (error) {
            console.error('Erro ao buscar:', error);
        }
    }, 300);
});

function renderizarAutocomplete(acoes) {
    const list = document.getElementById('autocompleteList');
    state.acoes = acoes;
    
    let html = '';
    for (let i = 0; i < acoes.length; i++) {
        const acao = acoes[i];
        html += '<div class="autocomplete-item" data-ticker="' + acao.ticker + '">';
        html += '<strong>' + acao.ticker + '</strong> ';
        html += '<small>' + acao.nome + '</small>';
        html += '</div>';
    }
    
    list.innerHTML = html;
    list.classList.add('active');
    
    // Adicionar listeners
    document.querySelectorAll('.autocomplete-item').forEach(function(item) {
        item.addEventListener('click', function() {
            const ticker = this.dataset.ticker;
            selecionarAcao(ticker);
        });
    });
}

function selecionarAcao(ticker) {
    document.getElementById('inputBusca').value = ticker;
    document.getElementById('autocompleteList').classList.remove('active');
    
    // Mostrar loading e calcular
    mostrarLoading();
    calcularValuation(ticker);
}

// ============================================================
// CALCULAR VALUATION
// ============================================================

async function calcularValuation(ticker) {
    try {
        const response = await fetch(
            '/investments/api/calcular-valuation/?ticker=' + encodeURIComponent(ticker)
        );
        
        if (!response.ok) {
            const data = await response.json();
            mostrarErro(data.erro || 'Erro ao calcular valuation');
            return;
        }
        
        const data = await response.json();
        state.resultadoAtual = data.resultado;
        renderizarResultado(data.resultado);
        
    } catch (error) {
        console.error('Erro:', error);
        mostrarErro('Erro ao calcular valuation');
    }
}

// ============================================================
// RENDERIZAR RESULTADO
// ============================================================

function renderizarResultado(resultado) {
    // Header
    document.getElementById('resultadoTicker').textContent = resultado.ticker;
    document.getElementById('resultadoPreco').textContent = resultado.preco_atual;
    
    // Recomenda√ß√£o Geral
    const statusEl = document.getElementById('statusGeral');
    const statusClass = resultado.recomendacao.status.toLowerCase();
    statusEl.textContent = resultado.recomendacao.emoji + ' ' + resultado.recomendacao.status;
    statusEl.className = 'recomendacao-status ' + statusClass;
    
    document.getElementById('pontosCompra').textContent = resultado.recomendacao.pontos_compra;
    document.getElementById('pontosVenda').textContent = resultado.recomendacao.pontos_venda;
    
    // BAZIN
    renderizarMetodo('bazin', resultado.bazin);
    
    // GRAHAM
    renderizarMetodo('graham', resultado.graham);
    
    // LYNCH
    renderizarMetodo('lynch', resultado.lynch);
    
    // Mostrar resultado
    document.getElementById('loadingDiv').style.display = 'none';
    document.getElementById('erroDiv').style.display = 'none';
    document.getElementById('conteudoResultado').style.display = 'block';
    document.getElementById('resultadoSection').classList.add('active');
}

function renderizarMetodo(metodo, dados) {
    const card = document.getElementById(metodo + 'Card');
    const emojiEl = document.getElementById(metodo + 'Emoji');
    const precoEl = document.getElementById(metodo + 'Preco');
    const margemEl = document.getElementById(metodo + 'Margem');
    const statusEl = document.getElementById(metodo + 'Status');
    
    // Emoji e cor do card
    const statusLower = dados.status.toLowerCase();
    emojiEl.textContent = dados.emoji;
    card.classList.remove('comprar', 'vender', 'aguardar');
    card.classList.add(statusLower);
    
    // Pre√ßo/PEG
    if (metodo === 'lynch') {
        precoEl.style.display = 'none';
        document.getElementById('lynchPeg').textContent = dados.peg || 'N/A';
        document.getElementById('lynchPreco').textContent = dados.preco_ideal || 'N/A';
    } else {
        precoEl.style.display = 'block';
        const chavePreco = metodo === 'bazin' ? 'preco_teto' : 'preco_justo';
        precoEl.textContent = dados[chavePreco] || 'N/A';
    }
    
    // Margem
    margemEl.textContent = dados.margem || 'N/A';
    
    // Status
    statusEl.textContent = dados.emoji + ' ' + dados.status;
    statusEl.className = 'metodo-status status-' + statusLower;
}

function mostrarLoading() {
    document.getElementById('resultadoSection').classList.add('active');
    document.getElementById('loadingDiv').style.display = 'block';
    document.getElementById('erroDiv').style.display = 'none';
    document.getElementById('conteudoResultado').style.display = 'none';
}

function mostrarErro(mensagem) {
    const erroDiv = document.getElementById('erroDiv');
    erroDiv.textContent = '‚ö†Ô∏è ' + mensagem;
    erroDiv.style.display = 'block';
    
    document.getElementById('resultadoSection').classList.add('active');
    document.getElementById('loadingDiv').style.display = 'none';
    document.getElementById('conteudoResultado').style.display = 'none';
}

// Fechar autocomplete ao clicar fora
document.addEventListener('click', function(e) {
    if (e.target.id !== 'inputBusca') {
        document.getElementById('autocompleteList').classList.remove('active');
    }
});
</script>
{% endblock %}