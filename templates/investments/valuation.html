{% extends 'base.html' %}

{% block title %}An√°lise Fundamentalista - RUMO1M{% endblock %}

{% block extra_css %}
<style>
    /* Hero Section */
    .valuation-hero {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        border-radius: var(--radius-2xl);
        padding: 3rem 2rem;
        color: var(--white);
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .valuation-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 500px;
        height: 500px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
    
    .valuation-hero-content {
        position: relative;
        z-index: 1;
    }
    
    .valuation-hero h1 {
        font-family: var(--font-display);
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
    }
    
    .valuation-hero p {
        font-size: 1.25rem;
        opacity: 0.95;
    }
    
    /* Search Section */
    .search-card {
        background: var(--white);
        border-radius: var(--radius-2xl);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
    }
    
    .search-input-wrapper {
        position: relative;
        max-width: 600px;
        margin: 0 auto;
    }
    
    .search-input {
        width: 100%;
        padding: 1.25rem 3.5rem 1.25rem 1.5rem;
        font-size: 1.125rem;
        border: 3px solid var(--gray-200);
        border-radius: var(--radius-xl);
        transition: all var(--transition-base);
        background: var(--gray-50);
        font-weight: 500;
    }
    
    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        background: var(--white);
    }
    
    .search-icon {
        position: absolute;
        right: 1.5rem;
        top: 50%;
        transform: translateY(-50%);
        font-size: 1.5rem;
        color: var(--gray-400);
        pointer-events: none;
    }
    
    /* Autocomplete */
    .autocomplete-list {
        position: absolute;
        top: calc(100% + 0.75rem);
        left: 0;
        right: 0;
        background: var(--white);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .autocomplete-list.active {
        display: block;
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .autocomplete-item {
        padding: 1.25rem 1.5rem;
        cursor: pointer;
        transition: all var(--transition-fast);
        border-bottom: 1px solid var(--gray-100);
    }
    
    .autocomplete-item:hover {
        background: var(--gray-50);
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .autocomplete-item strong {
        color: var(--primary);
        font-weight: 700;
        font-size: 1.125rem;
    }
    
    /* Loading */
    .loading-container {
        text-align: center;
        padding: 4rem 2rem;
    }
    
    .loading-spinner {
        width: 64px;
        height: 64px;
        border: 6px solid var(--gray-200);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .loading-text {
        font-size: 1.25rem;
        color: var(--gray-600);
        font-weight: 500;
    }
    
    /* Error */
    .error-card {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
        border-left: 4px solid var(--danger);
        border-radius: var(--radius-xl);
        padding: 2rem;
        color: #991b1b;
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 1.125rem;
    }
    
    /* Stock Header */
    .stock-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: var(--radius-2xl);
        padding: 3rem 2rem;
        color: var(--white);
        margin-bottom: 2rem;
        text-align: center;
        box-shadow: var(--shadow-xl);
    }
    
    .stock-header h1 {
        font-family: var(--font-display);
        font-size: 3.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
    }
    
    .stock-price {
        font-size: 2.5rem;
        font-weight: 700;
        opacity: 0.95;
    }
    
    /* Fundamentals Grid */
    .fundamentals-card {
        background: var(--white);
        border-radius: var(--radius-2xl);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
    }
    
    .fundamentals-card h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .fundamentals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1.5rem;
    }
    
    .fundamental-item {
        text-align: center;
        padding: 1.5rem;
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        transition: all var(--transition-base);
    }
    
    .fundamental-item:hover {
        background: var(--gray-100);
        transform: translateY(-4px);
    }
    
    .fundamental-label {
        font-size: 0.875rem;
        color: var(--gray-600);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
    }
    
    .fundamental-value {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--primary);
        font-family: var(--font-display);
    }
    
    .fundamental-subtitle {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 0.5rem;
    }
    
    /* AI Analysis */
    .ai-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: var(--radius-2xl);
        padding: 2.5rem;
        color: var(--white);
        margin-bottom: 2rem;
        box-shadow: var(--shadow-xl);
    }
    
    .ai-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .ai-header i {
        font-size: 3rem;
    }
    
    .ai-header h2 {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
    }
    
    .ai-content {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        padding: 2rem;
        border-radius: var(--radius-xl);
        border: 1px solid rgba(255, 255, 255, 0.2);
        line-height: 1.8;
        font-size: 1.0625rem;
    }
    
    /* News Card */
    .news-card {
        background: var(--white);
        border-radius: var(--radius-2xl);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
    }
    
    .news-card h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .news-content {
        padding: 1.5rem;
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        border-left: 4px solid var(--primary);
        line-height: 1.7;
        color: var(--gray-700);
    }
    
    /* Recomenda√ß√£o */
    .recommendation-card {
        background: var(--white);
        border-radius: var(--radius-2xl);
        padding: 3rem 2rem;
        box-shadow: var(--shadow-xl);
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .recommendation-status {
        font-size: 4rem;
        font-weight: 900;
        font-family: var(--font-display);
        margin: 1.5rem 0;
    }
    
    .recommendation-status.comprar {
        color: var(--secondary);
        text-shadow: 2px 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    .recommendation-status.vender {
        color: var(--danger);
        text-shadow: 2px 2px 8px rgba(239, 68, 68, 0.3);
    }
    
    .recommendation-status.aguardar {
        color: var(--accent);
        text-shadow: 2px 2px 8px rgba(245, 158, 11, 0.3);
    }
    
    .recommendation-votes {
        display: flex;
        justify-content: center;
        gap: 3rem;
        margin-top: 2rem;
    }
    
    .vote-item {
        text-align: center;
    }
    
    .vote-number {
        font-size: 3rem;
        font-weight: 800;
        color: var(--primary);
        font-family: var(--font-display);
    }
    
    .vote-label {
        font-size: 1rem;
        color: var(--gray-600);
        font-weight: 500;
        margin-top: 0.5rem;
    }
    
    /* Methods Grid */
    .methods-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .method-card {
        background: var(--white);
        border-radius: var(--radius-2xl);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
        border: 3px solid transparent;
        transition: all var(--transition-base);
    }
    
    .method-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }
    
    .method-card.comprar {
        border-color: var(--secondary);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);
    }
    
    .method-card.vender {
        border-color: var(--danger);
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(239, 68, 68, 0.02) 100%);
    }
    
    .method-card.aguardar {
        border-color: var(--accent);
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(245, 158, 11, 0.02) 100%);
    }
    
    .method-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .method-emoji {
        font-size: 2.5rem;
    }
    
    .method-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin: 0;
        font-family: var(--font-display);
    }
    
    .method-description {
        font-size: 0.9375rem;
        color: var(--gray-600);
        margin-bottom: 1.5rem;
    }
    
    .method-price {
        font-size: 2.25rem;
        font-weight: 800;
        color: var(--primary);
        font-family: var(--font-display);
        text-align: center;
        padding: 1.5rem;
        background: rgba(37, 99, 235, 0.1);
        border-radius: var(--radius-lg);
        margin-bottom: 1rem;
    }
    
    .method-formula {
        font-size: 0.875rem;
        color: var(--gray-600);
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--radius);
        margin-bottom: 1rem;
        font-family: monospace;
    }
    
    .method-margin {
        display: flex;
        justify-content: space-between;
        padding: 1rem;
        background: rgba(37, 99, 235, 0.1);
        border-radius: var(--radius);
        margin-bottom: 1rem;
    }
    
    .method-margin-label {
        color: var(--gray-600);
        font-weight: 500;
    }
    
    .method-margin-value {
        font-weight: 700;
        color: var(--primary);
    }
    
    .method-status {
        padding: 1.25rem;
        border-radius: var(--radius-lg);
        text-align: center;
        font-weight: 700;
        font-size: 1.25rem;
    }
    
    .method-status.comprar {
        background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
        color: var(--white);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .method-status.vender {
        background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        color: var(--white);
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }
    
    .method-status.aguardar {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
        color: var(--white);
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }
    
    /* Info Card */
    .info-card {
        background: var(--white);
        border-radius: var(--radius-2xl);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
    }
    
    .info-card h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .info-item h3 {
        font-size: 1.125rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .info-item.success h3 { color: var(--secondary); }
    .info-item.warning h3 { color: var(--accent); }
    .info-item.danger h3 { color: var(--danger); }
    
    .info-item p {
        color: var(--gray-600);
        line-height: 1.6;
        margin: 0;
    }
    
    @media (max-width: 767px) {
        .valuation-hero h1 { font-size: 2rem; }
        .stock-header h1 { font-size: 2.5rem; }
        .stock-price { font-size: 1.75rem; }
        .recommendation-status { font-size: 2.5rem; }
        .methods-grid { grid-template-columns: 1fr; }
        .fundamentals-grid { grid-template-columns: repeat(2, 1fr); }
    }
</style>
{% endblock %}

{% block content %}

<!-- Hero -->
<section class="valuation-hero">
    <div class="valuation-hero-content">
        <h1>üìä An√°lise Fundamentalista</h1>
        <p>Valuation profissional com 3 metodologias + IA + Not√≠cias</p>
    </div>
</section>

<!-- Search -->
<section class="search-card">
    <div class="search-input-wrapper">
        <input 
            type="text" 
            id="inputBusca" 
            class="search-input" 
            placeholder="Digite o ticker da a√ß√£o (ex: PETR4, VALE3, ITUB4)..."
            autocomplete="off">
        <i class="bi bi-search search-icon"></i>
        <div id="autocompleteList" class="autocomplete-list"></div>
    </div>
</section>

<!-- Resultado -->
<div id="resultadoSection" style="display: none;">
    
    <!-- Erro -->
    <div id="erroDiv" style="display: none;" class="error-card"></div>
    
    <!-- Loading -->
    <div id="loadingDiv" style="display: none;" class="loading-container">
        <div class="loading-spinner"></div>
        <p class="loading-text">Analisando a√ß√£o e buscando not√≠cias...</p>
    </div>
    
    <!-- Conte√∫do -->
    <div id="conteudoResultado" style="display: none;">
        
        <!-- Stock Header -->
        <div class="stock-header">
            <h1 id="resultadoTicker"></h1>
            <div class="stock-price" id="resultadoPreco"></div>
        </div>
        
        <!-- Fundamentals -->
        <div class="fundamentals-card">
            <h2>
                <i class="bi bi-bar-chart-line"></i>
                Dados Fundamentalistas
            </h2>
            <div class="fundamentals-grid">
                <div class="fundamental-item">
                    <div class="fundamental-label">Pre√ßo Atual</div>
                    <div class="fundamental-value" id="dadoPreco">-</div>
                </div>
                <div class="fundamental-item">
                    <div class="fundamental-label">LPA (EPS)</div>
                    <div class="fundamental-value" id="dadoEPS">-</div>
                    <div class="fundamental-subtitle">Lucro por A√ß√£o</div>
                </div>
                <div class="fundamental-item">
                    <div class="fundamental-label">P/L</div>
                    <div class="fundamental-value" id="dadoPE">-</div>
                    <div class="fundamental-subtitle">Pre√ßo / Lucro</div>
                </div>
                <div class="fundamental-item">
                    <div class="fundamental-label">ROE</div>
                    <div class="fundamental-value" id="dadoROE">-</div>
                    <div class="fundamental-subtitle">Retorno s/ PL</div>
                </div>
                <div class="fundamental-item">
                    <div class="fundamental-label">Dividend Yield</div>
                    <div class="fundamental-value" id="dadoDY">-</div>
                    <div class="fundamental-subtitle">Dividendos Anuais</div>
                </div>
            </div>
        </div>
        
        <!-- AI Analysis -->
        <div class="ai-card">
            <div class="ai-header">
                <i class="bi bi-robot"></i>
                <h2>An√°lise do Especialista IA</h2>
            </div>
            <div class="ai-content" id="aiAnalysis">
                Carregando an√°lise...
            </div>
        </div>
        
        <!-- News -->
        <div class="news-card">
            <h2>
                <i class="bi bi-newspaper"></i>
                √öltimas Not√≠cias
            </h2>
            <div class="news-content" id="newsContent">
                Carregando not√≠cias...
            </div>
        </div>
        
        <!-- Recomenda√ß√£o -->
        <div class="recommendation-card">
            <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0;">Recomenda√ß√£o Consolidada</h2>
            <div class="recommendation-status" id="statusGeral"></div>
            <div class="recommendation-votes">
                <div class="vote-item">
                    <div class="vote-number" id="pontosCompra">0</div>
                    <div class="vote-label">M√©todos para COMPRAR</div>
                </div>
                <div class="vote-item">
                    <div class="vote-number" id="pontosVenda">0</div>
                    <div class="vote-label">M√©todos para VENDER</div>
                </div>
            </div>
        </div>
        
        <!-- Methods -->
        <div class="methods-grid">
            <!-- BAZIN -->
            <div class="method-card" id="bazinCard">
                <div class="method-header">
                    <span class="method-emoji" id="bazinEmoji">üü°</span>
                    <h3 class="method-title">M√©todo Bazin</h3>
                </div>
                <p class="method-description">Pre√ßo-teto baseado em Dividend Yield (6% a.a.)</p>
                <div class="method-price" id="bazinPreco">N/A</div>
                <div class="method-formula" id="bazinFormula">Calculando...</div>
                <div class="method-margin">
                    <span class="method-margin-label">Margem de Seguran√ßa:</span>
                    <span class="method-margin-value" id="bazinMargem">N/A</span>
                </div>
                <div class="method-status" id="bazinStatus">DADOS INSUFICIENTES</div>
            </div>
            
            <!-- GRAHAM -->
            <div class="method-card" id="grahamCard">
                <div class="method-header">
                    <span class="method-emoji" id="grahamEmoji">üü°</span>
                    <h3 class="method-title">M√©todo Graham</h3>
                </div>
                <p class="method-description">Pre√ßo justo usando P/L e VPA</p>
                <div class="method-price" id="grahamPreco">N/A</div>
                <div class="method-formula" id="grahamFormula">Calculando...</div>
                <div class="method-margin">
                    <span class="method-margin-label">Margem de Seguran√ßa:</span>
                    <span class="method-margin-value" id="grahamMargem">N/A</span>
                </div>
                <div class="method-status" id="grahamStatus">DADOS INSUFICIENTES</div>
            </div>
            
            <!-- LYNCH -->
            <div class="method-card" id="lynchCard">
                <div class="method-header">
                    <span class="method-emoji" id="lynchEmoji">üü°</span>
                    <h3 class="method-title">M√©todo Lynch (PEG)</h3>
                </div>
                <p class="method-description">P/E Ratio √∑ Taxa de Crescimento (ROE)</p>
                <div class="method-price">
                    <div style="font-size: 1rem; color: var(--gray-600); margin-bottom: 0.5rem;">PEG Ratio</div>
                    <span id="lynchPeg">N/A</span>
                </div>
                <div class="method-formula" id="lynchFormula">Calculando...</div>
                <div class="method-margin">
                    <span class="method-margin-label">Pre√ßo Ideal:</span>
                    <span class="method-margin-value" id="lynchPreco">N/A</span>
                </div>
                <div class="method-status" id="lynchStatus">DADOS INSUFICIENTES</div>
            </div>
        </div>
        
        <!-- Info -->
        <div class="info-card">
            <h2>
                <i class="bi bi-book"></i>
                Como Interpretar os Resultados
            </h2>
            <div class="info-grid">
                <div class="info-item success">
                    <h3><i class="bi bi-check-circle"></i> COMPRAR</h3>
                    <p>A√ß√£o com pre√ßo abaixo do calculado. Boa oportunidade de entrada.</p>
                </div>
                <div class="info-item warning">
                    <h3><i class="bi bi-pause-circle"></i> AGUARDAR</h3>
                    <p>Pre√ßo pr√≥ximo ao justo. Aguarde melhor oportunidade.</p>
                </div>
                <div class="info-item danger">
                    <h3><i class="bi bi-x-circle"></i> VENDER</h3>
                    <p>A√ß√£o acima do pre√ßo justo. Considere realizar lucro.</p>
                </div>
            </div>
            <hr style="border-color: var(--gray-200); margin: 1.5rem 0;">
            <p style="color: var(--gray-600); line-height: 1.7; margin: 0;">
                <strong>Bazin:</strong> Ideal para dividendos (DY 6%) ‚Ä¢ 
                <strong>Graham:</strong> An√°lise fundamental cl√°ssica ‚Ä¢ 
                <strong>Lynch:</strong> Compara P/L com crescimento (PEG < 1 = subavaliado)
            </p>
        </div>
        
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const state = { timeout: null };

// Autocomplete
document.getElementById('inputBusca').addEventListener('input', function(e) {
    clearTimeout(state.timeout);
    const query = e.target.value.trim();
    
    if (query.length < 2) {
        document.getElementById('autocompleteList').classList.remove('active');
        return;
    }
    
    state.timeout = setTimeout(async function() {
        try {
            const response = await fetch('/investments/api/buscar-acoes-valuation/?q=' + encodeURIComponent(query));
            const data = await response.json();
            
            if (data.resultados && data.resultados.length > 0) {
                renderizarAutocomplete(data.resultados);
            } else {
                document.getElementById('autocompleteList').classList.remove('active');
            }
        } catch (error) {
            console.error('Erro:', error);
        }
    }, 300);
});

function renderizarAutocomplete(acoes) {
    const list = document.getElementById('autocompleteList');
    list.innerHTML = acoes.map(a => `
        <div class="autocomplete-item" data-ticker="${a.ticker}">
            <strong>${a.ticker}</strong> - ${a.nome}
        </div>
    `).join('');
    list.classList.add('active');
    
    document.querySelectorAll('.autocomplete-item').forEach(item => {
        item.addEventListener('click', function() {
            selecionarAcao(this.dataset.ticker);
        });
    });
}

function selecionarAcao(ticker) {
    document.getElementById('inputBusca').value = ticker;
    document.getElementById('autocompleteList').classList.remove('active');
    mostrarLoading();
    calcularValuation(ticker);
}

async function calcularValuation(ticker) {
    try {
        const response = await fetch('/investments/api/calcular-valuation/?ticker=' + encodeURIComponent(ticker));
        
        if (!response.ok) {
            const data = await response.json();
            mostrarErro(data.erro || 'Erro ao calcular valuation');
            return;
        }
        
        const data = await response.json();
        renderizarResultado(data.resultado);
        
    } catch (error) {
        console.error('Erro:', error);
        mostrarErro('Erro ao processar an√°lise. Tente novamente.');
    }
}

function renderizarResultado(resultado) {
    document.getElementById('resultadoTicker').textContent = resultado.ticker;
    document.getElementById('resultadoPreco').textContent = resultado.preco_atual;
    
    if (resultado.dados_base) {
        document.getElementById('dadoPreco').textContent = resultado.dados_base.preco;
        document.getElementById('dadoEPS').textContent = resultado.dados_base.lpa;
        document.getElementById('dadoPE').textContent = resultado.dados_base.pl;
        document.getElementById('dadoROE').textContent = resultado.dados_base.roe;
        document.getElementById('dadoDY').textContent = resultado.dados_base.dy;
    }
    
    document.getElementById('aiAnalysis').textContent = resultado.ai_analysis || 'An√°lise n√£o dispon√≠vel';
    document.getElementById('newsContent').textContent = resultado.news_summary || 'Not√≠cias n√£o dispon√≠veis';
    
    const statusEl = document.getElementById('statusGeral');
    statusEl.textContent = resultado.recomendacao.emoji + ' ' + resultado.recomendacao.status;
    statusEl.className = 'recommendation-status ' + resultado.recomendacao.status.toLowerCase();
    
    document.getElementById('pontosCompra').textContent = resultado.recomendacao.pontos_compra;
    document.getElementById('pontosVenda').textContent = resultado.recomendacao.pontos_venda;
    
    renderizarMetodo('bazin', resultado.bazin);
    renderizarMetodo('graham', resultado.graham);
    renderizarMetodo('lynch', resultado.lynch);
    
    document.getElementById('loadingDiv').style.display = 'none';
    document.getElementById('erroDiv').style.display = 'none';
    document.getElementById('conteudoResultado').style.display = 'block';
    document.getElementById('resultadoSection').style.display = 'block';
}

function renderizarMetodo(metodo, dados) {
    const card = document.getElementById(metodo + 'Card');
    const emojiEl = document.getElementById(metodo + 'Emoji');
    const precoEl = document.getElementById(metodo + 'Preco');
    const margemEl = document.getElementById(metodo + 'Margem');
    const statusEl = document.getElementById(metodo + 'Status');
    const formulaEl = document.getElementById(metodo + 'Formula');
    
    const statusLower = dados.status.toLowerCase();
    emojiEl.textContent = dados.emoji;
    card.className = 'method-card ' + statusLower;
    
    if (metodo === 'lynch') {
        document.getElementById('lynchPeg').textContent = dados.peg || 'N/A';
        document.getElementById('lynchPreco').textContent = dados.preco_ideal || 'N/A';
    } else {
        const chavePreco = metodo === 'bazin' ? 'preco_teto' : 'preco_justo';
        precoEl.textContent = dados[chavePreco] || 'N/A';
    }
    
    if (dados.formula) {
        formulaEl.innerHTML = '<i class="bi bi-calculator"></i> ' + dados.formula;
    }
    
    margemEl.textContent = dados.margem || 'N/A';
    statusEl.textContent = dados.emoji + ' ' + dados.status;
    statusEl.className = 'method-status ' + statusLower;
}

function mostrarLoading() {
    document.getElementById('resultadoSection').style.display = 'block';
    document.getElementById('loadingDiv').style.display = 'block';
    document.getElementById('erroDiv').style.display = 'none';
    document.getElementById('conteudoResultado').style.display = 'none';
}

function mostrarErro(mensagem) {
    const erroDiv = document.getElementById('erroDiv');
    erroDiv.innerHTML = '<i class="bi bi-exclamation-triangle-fill" style="font-size: 2rem;"></i><span>' + mensagem + '</span>';
    erroDiv.style.display = 'flex';
    
    document.getElementById('resultadoSection').style.display = 'block';
    document.getElementById('loadingDiv').style.display = 'none';
    document.getElementById('conteudoResultado').style.display = 'none';
}

document.addEventListener('click', function(e) {
    if (e.target.id !== 'inputBusca') {
        document.getElementById('autocompleteList').classList.remove('active');
    }
});
</script>
{% endblock %}