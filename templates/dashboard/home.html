{% extends 'base.html' %}

{% block title %}Dashboard - RUMO1M{% endblock %}

{% block extra_css %}
<style>
    /* Hero Section */
    .hero {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        border-radius: var(--radius-2xl);
        padding: 3rem 2rem;
        color: var(--white);
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 500px;
        height: 500px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
    
    .hero-content {
        position: relative;
        z-index: 1;
    }
    
    .hero h1 {
        font-family: var(--font-display);
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
    }
    
    .hero p {
        font-size: 1.125rem;
        opacity: 0.95;
    }
    
    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: var(--white);
        padding: 1.5rem;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        transition: all var(--transition-base);
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
        border-color: var(--primary);
    }
    
    .stat-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: var(--gray-500);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
        font-family: var(--font-display);
    }
    
    /* CARD DE PLANEJAMENTO - AGORA VERDE! */
    .planning-card {
        background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
        border-radius: var(--radius-2xl);
        padding: 2rem;
        color: var(--white);
        margin-bottom: 2rem;
        box-shadow: var(--shadow-xl);
    }
    
    .planning-values {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .planning-value {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .planning-value.highlighted {
        background: rgba(255, 255, 255, 0.25);
        border: 2px solid rgba(255, 255, 255, 0.4);
    }
    
    .planning-value-label {
        font-size: 0.875rem;
        opacity: 0.9;
        margin-bottom: 0.5rem;
    }
    
    .planning-value-amount {
        font-size: 2rem;
        font-weight: 700;
        font-family: var(--font-display);
    }
    
    /* ============================================================
       BADGES EMPOLGANTES
       ============================================================ */
    .badges-section {
        margin-bottom: 2rem;
    }
    
    .badge-achievement {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 4px solid var(--accent);
        border-radius: var(--radius-2xl);
        padding: 2.5rem 2rem;
        margin-bottom: 1.5rem;
        position: relative;
        overflow: hidden;
        animation: badgePulse 2s infinite;
    }
    
    @keyframes badgePulse {
        0%, 100% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
        50% { box-shadow: 0 0 40px rgba(245, 158, 11, 0.6); }
    }
    
    .badge-achievement::before {
        content: 'âœ¨';
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 3rem;
        animation: sparkle 1.5s infinite;
    }
    
    @keyframes sparkle {
        0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
        50% { opacity: 0.7; transform: scale(1.2) rotate(180deg); }
    }
    
    .badge-emoji {
        font-size: 5rem;
        text-align: center;
        margin-bottom: 1rem;
        animation: bounce 2s infinite;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-15px); }
    }
    
    .badge-content {
        text-align: center;
    }
    
    .badge-title {
        font-family: var(--font-display);
        font-size: 2.5rem;
        font-weight: 900;
        color: var(--accent-dark);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: -0.5px;
    }
    
    .badge-message {
        font-size: 1.25rem;
        color: #92400e;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .badge-value {
        font-size: 3rem;
        font-weight: 800;
        color: var(--accent-dark);
        font-family: var(--font-display);
    }
    
    .badge-check {
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 3rem;
        color: var(--success);
        animation: checkPulse 1.5s infinite;
    }
    
    @keyframes checkPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }
    
    /* PrÃ³ximo Badge */
    .badge-next {
        background: var(--white);
        border-radius: var(--radius-2xl);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
        border: 2px solid var(--gray-200);
        transition: all var(--transition-base);
    }
    
    .badge-next:hover {
        border-color: var(--primary);
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }
    
    .badge-next-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .badge-next-emoji {
        font-size: 3rem;
        filter: grayscale(100%);
        opacity: 0.5;
    }
    
    .badge-next-info h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
    }
    
    .badge-next-info p {
        color: var(--gray-600);
        margin: 0;
    }
    
    .badge-progress-bar {
        background: var(--gray-200);
        height: 12px;
        border-radius: var(--radius-full);
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .badge-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        border-radius: var(--radius-full);
        transition: width 1s ease-out;
    }
    
    .badge-progress-info {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        color: var(--gray-600);
    }
    
    .badge-progress-percent {
        font-weight: 700;
        color: var(--primary);
    }
    
    /* Chart Container */
    .chart-card {
        background: var(--white);
        border-radius: var(--radius-2xl);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
    }
    
    .chart-card h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
    }
    
    /* Grid de GrÃ¡ficos */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    /* Carteira */
    .portfolio-section {
        margin-bottom: 2rem;
    }
    
    .portfolio-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .asset-card {
        background: var(--white);
        border-radius: var(--radius-xl);
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        border-left: 4px solid var(--primary);
        transition: all var(--transition-base);
    }
    
    .asset-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl);
    }
    
    .asset-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .asset-logo {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-md);
        object-fit: contain;
        background: var(--gray-100);
        padding: 0.5rem;
    }
    
    .asset-info h4 {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--gray-900);
        margin: 0;
    }
    
    .asset-info p {
        font-size: 0.875rem;
        color: var(--gray-600);
        margin: 0;
    }
    
    .asset-stats {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .asset-stat {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
    }
    
    .asset-stat-label {
        color: var(--gray-600);
    }
    
    .asset-stat-value {
        font-weight: 600;
        color: var(--gray-900);
    }
    
    .asset-profit {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .profit-positive {
        color: var(--success);
        font-weight: 700;
    }
    
    .profit-negative {
        color: var(--danger);
        font-weight: 700;
    }
    
    /* HistÃ³rico de Aportes */
    .history-card {
        background: var(--white);
        border-radius: var(--radius-2xl);
        padding: 2rem;
        box-shadow: var(--shadow-lg);
        margin-bottom: 2rem;
    }
    
    .history-card h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .aporte-item {
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 4px solid var(--secondary);
        transition: all var(--transition-fast);
    }
    
    .aporte-item:hover {
        background: var(--gray-100);
        transform: translateX(4px);
    }
    
    .aporte-valor {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.25rem;
    }
    
    .aporte-data {
        color: var(--gray-600);
        font-size: 0.875rem;
    }
    
    .aporte-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-icon {
        width: 36px;
        height: 36px;
        border-radius: var(--radius);
        border: none;
        background: var(--gray-200);
        color: var(--gray-700);
        cursor: pointer;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-icon:hover {
        background: var(--primary);
        color: var(--white);
        transform: scale(1.1);
    }
    
    .btn-icon.danger:hover {
        background: var(--danger);
    }
    
    /* Floating Button */
    .floating-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-size: 1.75rem;
        box-shadow: var(--shadow-xl);
        transition: all var(--transition-base);
        z-index: 999;
    }
    
    .floating-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 20px 40px rgba(37, 99, 235, 0.4);
    }
    
    @media (max-width: 767px) {
        .hero h1 { font-size: 2rem; }
        .badge-title { font-size: 2rem; }
        .badge-value { font-size: 2rem; }
        .stat-value { font-size: 1.5rem; }
        .chart-container { height: 300px; }
        .charts-grid { grid-template-columns: 1fr; }
        .portfolio-grid { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}

<!-- Hero -->
<section class="hero">
    <div class="hero-content">
        <h1>Bem-vindo de volta, {{ user.first_name|default:user.username }}!</h1>
        <p>Acompanhe sua jornada rumo ao primeiro milhÃ£o ðŸš€</p>
    </div>
</section>

<!-- Stats Grid -->
<section class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <i class="bi bi-cash-stack"></i>
        </div>
        <div class="stat-label">Total Investido</div>
        <div class="stat-value" style="color: var(--secondary);">R$ {{ total|floatformat:2 }}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
            <i class="bi bi-calendar-check"></i>
        </div>
        <div class="stat-label">Aportes Realizados</div>
        <div class="stat-value">{{ qtd_aportes }}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            <i class="bi bi-graph-up"></i>
        </div>
        <div class="stat-label">MÃ©dia Mensal</div>
        <div class="stat-value" style="color: var(--accent);">R$ {{ media_mensal|floatformat:2 }}</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
            <i class="bi bi-arrow-up-circle"></i>
        </div>
        <div class="stat-label">Maior Aporte</div>
        <div class="stat-value" style="color: #7c3aed;">R$ {{ maior_aporte|floatformat:2 }}</div>
    </div>
</section>

<!-- Planejamento - AGORA VERDE! -->
{% if tem_planejamento %}
<section class="planning-card">
    <h2 style="margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.75rem;">
        <i class="bi bi-calendar-check"></i>
        Planejamento Mensal
    </h2>
    <p style="margin: 0; opacity: 0.9;">Valor corrigido automaticamente pela inflaÃ§Ã£o (IPCA)</p>
    
    <div class="planning-values">
        <div class="planning-value">
            <div class="planning-value-label">Valor Inicial</div>
            <div class="planning-value-amount">R$ {{ valor_planejado_base|floatformat:2 }}</div>
        </div>
        <div class="planning-value highlighted">
            <div class="planning-value-label">Corrigido (Hoje)</div>
            <div class="planning-value-amount">R$ {{ proximo_valor|floatformat:2 }}</div>
        </div>
    </div>
</section>
{% else %}
<div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%); border-left: 4px solid var(--accent); border-radius: var(--radius-xl); padding: 1.5rem; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
        <strong style="display: flex; align-items: center; gap: 0.5rem; color: var(--accent-dark); margin-bottom: 0.5rem;">
            <i class="bi bi-exclamation-triangle"></i> Configure seu planejamento mensal!
        </strong>
        <p style="margin: 0; color: var(--gray-700);">Defina quanto quer investir por mÃªs e o sistema corrige pela inflaÃ§Ã£o automaticamente.</p>
    </div>
</div>
{% endif %}

<!-- Badges Section -->
<section class="badges-section">
    {% if badges.atual %}
    <div class="badge-achievement">
        <div class="badge-check">
            <i class="bi bi-check-circle-fill"></i>
        </div>
        <div class="badge-emoji">{{ badges.atual.emoji }}</div>
        <div class="badge-content">
            <div class="badge-title">{{ badges.atual.titulo }}</div>
            <div class="badge-message">{{ badges.atual.mensagem }}</div>
            <div class="badge-value">R$ {{ badges.atual.valor|floatformat:0 }}</div>
        </div>
    </div>
    {% endif %}
    
    {% if not badges.proximo.alcancado %}
    <div class="badge-next">
        <div class="badge-next-header">
            <div class="badge-next-emoji">{{ badges.proximo.emoji }}</div>
            <div class="badge-next-info">
                <h3>{{ badges.proximo.titulo }}</h3>
                <p>{{ badges.proximo.mensagem }}</p>
            </div>
        </div>
        
        <div class="badge-progress-bar">
            <div class="badge-progress-fill" style="width: {{ badges.progresso }}%;"></div>
        </div>
        
        <div class="badge-progress-info">
            <span>Meta: <strong>R$ {{ badges.proximo.valor|floatformat:0 }}</strong></span>
            <span class="badge-progress-percent">{{ badges.progresso }}% completo</span>
        </div>
        
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200); color: var(--gray-600); text-align: center;">
            Faltam <strong style="color: var(--primary);">R$ {{ badges.falta|floatformat:2 }}</strong> para o prÃ³ximo marco!
        </div>
    </div>
    {% else %}
    <div class="badge-achievement">
        <div class="badge-emoji">ðŸ‘‘</div>
        <div class="badge-content">
            <div class="badge-title">VOCÃŠ CONQUISTOU O MILHÃƒO!</div>
            <div class="badge-message">ParabÃ©ns pela disciplina e determinaÃ§Ã£o! ðŸŽŠ</div>
        </div>
    </div>
    {% endif %}
</section>

<!-- GrÃ¡ficos em Grid -->
<section class="charts-grid">
    <!-- GrÃ¡fico de Barras - PatrimÃ´nio por MÃªs -->
    <div class="chart-card">
        <h2>
            <i class="bi bi-bar-chart"></i>
            PatrimÃ´nio por MÃªs
        </h2>
        <div class="chart-container">
            <canvas id="graficoBarras"></canvas>
        </div>
    </div>
    
    <!-- GrÃ¡fico de Rosca - DiversificaÃ§Ã£o -->
    {% if tem_carteira %}
    <div class="chart-card">
        <h2>
            <i class="bi bi-pie-chart"></i>
            DiversificaÃ§Ã£o da Carteira
        </h2>
        <div class="chart-container">
            <canvas id="graficoRosca"></canvas>
        </div>
    </div>
    {% endif %}
</section>

<!-- Chart de Linha - EvoluÃ§Ã£o -->
<section class="chart-card">
    <h2>
        <i class="bi bi-graph-up"></i>
        EvoluÃ§Ã£o Patrimonial e ProjeÃ§Ãµes
    </h2>
    <div class="chart-container">
        <canvas id="graficoLinha"></canvas>
    </div>
</section>

<!-- Carteira de Investimentos -->
{% if tem_carteira %}
<section class="portfolio-section">
    <div class="chart-card">
        <h2>
            <i class="bi bi-wallet2"></i>
            Minha Carteira
        </h2>
        
        <!-- KPIs da Carteira -->
        <div class="stats-grid" style="margin-top: 1.5rem;">
            <div class="stat-card">
                <div class="stat-label">Investido</div>
                <div class="stat-value" style="color: var(--primary);">R$ {{ total_investido_carteira|floatformat:2 }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Valor Atual</div>
                <div class="stat-value" style="color: var(--secondary);">R$ {{ total_mercado_carteira|floatformat:2 }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Lucro/PrejuÃ­zo</div>
                <div class="stat-value {% if lucro_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if lucro_total >= 0 %}+{% endif %}R$ {{ lucro_total|floatformat:2 }}
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Rentabilidade</div>
                <div class="stat-value {% if rentabilidade >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {% if rentabilidade >= 0 %}+{% endif %}{{ rentabilidade|floatformat:2 }}%
                </div>
            </div>
        </div>
        
        <!-- PosiÃ§Ãµes -->
        <div class="portfolio-grid">
            {% for chave, pos in carteira.items %}
            <div class="asset-card">
                <div class="asset-header">
                    {% if pos.logo %}
                    <img src="{{ pos.logo }}" alt="{{ pos.ticker }}" class="asset-logo">
                    {% else %}
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                        {{ pos.ticker|slice:":2"|default:"--" }}
                    </div>
                    {% endif %}
                    <div class="asset-info">
                        <h4>{{ pos.ticker|default:pos.nome|truncatechars:10 }}</h4>
                        <p>{{ pos.nome|truncatechars:20 }}</p>
                    </div>
                </div>
                <div class="asset-stats">
                    <div class="asset-stat">
                        <span class="asset-stat-label">Quantidade:</span>
                        <span class="asset-stat-value">{{ pos.quantidade|floatformat:2 }}</span>
                    </div>
                    <div class="asset-stat">
                        <span class="asset-stat-label">PreÃ§o MÃ©dio:</span>
                        <span class="asset-stat-value">R$ {{ pos.valor_medio|floatformat:2 }}</span>
                    </div>
                    {% if pos.preco_atual %}
                    <div class="asset-stat">
                        <span class="asset-stat-label">PreÃ§o Atual:</span>
                        <span class="asset-stat-value">R$ {{ pos.preco_atual|floatformat:2 }}</span>
                    </div>
                    {% endif %}
                    <div class="asset-stat">
                        <span class="asset-stat-label">Total Investido:</span>
                        <span class="asset-stat-value">R$ {{ pos.valor_total|floatformat:2 }}</span>
                    </div>
                    {% if pos.valor_mercado %}
                    <div class="asset-stat">
                        <span class="asset-stat-label">Valor Atual:</span>
                        <span class="asset-stat-value">R$ {{ pos.valor_mercado|floatformat:2 }}</span>
                    </div>
                    {% endif %}
                </div>
                {% if pos.lucro_prejuizo is not None %}
                <div class="asset-profit">
                    <span style="color: var(--gray-600); font-size: 0.875rem;">L/P:</span>
                    <span class="{% if pos.lucro_prejuizo >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                        {% if pos.lucro_prejuizo >= 0 %}+{% endif %}R$ {{ pos.lucro_prejuizo|floatformat:2 }} 
                        ({% if pos.rentabilidade >= 0 %}+{% endif %}{{ pos.rentabilidade|floatformat:1 }}%)
                    </span>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- HistÃ³rico de Aportes -->
<section class="history-card">
    <h2>
        <i class="bi bi-clock-history"></i>
        Ãšltimas MovimentaÃ§Ãµes
    </h2>
    
    {% if ultimos_items %}
        {% for item in ultimos_items %}
        <div class="aporte-item">
            <div>
                <div class="aporte-valor">
                    {% if item.is_aporte %}
                        ðŸ’° Aporte - R$ {{ item.valor|floatformat:2 }}
                    {% else %}
                        {% if item.tipo == 'Compra' %}ðŸŸ¢{% else %}ðŸ”´{% endif %} {{ item.tipo }} - R$ {{ item.valor|floatformat:2 }}
                    {% endif %}
                </div>
                <div class="aporte-data">
                    {{ item.data|date:"d/m/Y" }}
                    {% if item.descricao %}
                    <span class="text-muted">Â· {{ item.descricao }}</span>
                    {% endif %}
                </div>
            </div>
            {% if item.is_aporte %}
            <div class="aporte-actions">
                <a href="{% url 'editar_aporte' item.id %}" class="btn-icon">
                    <i class="bi bi-pencil"></i>
                </a>
                <a href="{% url 'deletar_aporte' item.id %}" class="btn-icon danger">
                    <i class="bi bi-trash"></i>
                </a>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 3rem; color: var(--gray-500);">
            <i class="bi bi-inbox" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
            <p>Nenhuma movimentaÃ§Ã£o ainda</p>
            <p style="font-size: 0.875rem;">Adicione seu primeiro investimento para comeÃ§ar!</p>
        </div>
    {% endif %}
</section>

<!-- Floating Button -->
<a href="{% url 'adicionar_aporte' %}" class="floating-btn">
    <i class="bi bi-plus-lg"></i>
</a>

{% endblock %}

{% block extra_js %}
<script>
// âœ… CORRIGIDO: Dados do backend com validaÃ§Ã£o
const historico = {{ historico_acumulado|safe }};
const projecaoConservador = {{ projecao_conservador|safe }};
const projecaoModerado = {{ projecao_moderado|safe }};
const projecaoAgressivo = {{ projecao_agressivo|safe }};

// âœ… CORRIGIDO: Validar se dados existem e sÃ£o arrays
if (!Array.isArray(historico)) historico = [];
if (!Array.isArray(projecaoConservador)) projecaoConservador = [];
if (!Array.isArray(projecaoModerado)) projecaoModerado = [];
if (!Array.isArray(projecaoAgressivo)) projecaoAgressivo = [];

const mesesHistorico = historico.length;
const mesesProjecao = projecaoConservador.length;
const totalMeses = mesesHistorico + mesesProjecao;

const labels = [];
for (let i = 1; i <= totalMeses; i++) {
    labels.push(i);
}

const dataHistorico = [...historico].concat(Array(mesesProjecao).fill(null));
const dataConservador = Array(mesesHistorico).fill(null).concat(projecaoConservador);
const dataModerado = Array(mesesHistorico).fill(null).concat(projecaoModerado);
const dataAgressivo = Array(mesesHistorico).fill(null).concat(projecaoAgressivo);

// =============================================================================
// GRÃFICO DE LINHA - EvoluÃ§Ã£o e ProjeÃ§Ãµes
// =============================================================================
const ctxLinha = document.getElementById('graficoLinha');
const isMobile = window.innerWidth < 768;

// âœ… CORRIGIDO: Validar se elemento existe E se temos dados
if (ctxLinha && historico.length > 0) {
    new Chart(ctxLinha, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: isMobile ? 'ðŸ’° Acumulado' : 'ðŸ’° PatrimÃ´nio Acumulado',
                    data: dataHistorico,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 3,
                    tension: 0.3,
                    fill: true,
                    pointRadius: isMobile ? 0 : 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#2563eb',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                },
                {
                    label: isMobile ? 'ðŸŸ¢ 8%' : 'ðŸŸ¢ Conservador (8% a.a.)',
                    data: dataConservador,
                    borderColor: '#10b981',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                },
                {
                    label: isMobile ? 'ðŸŸ¡ 12%' : 'ðŸŸ¡ Moderado (12% a.a.)',
                    data: dataModerado,
                    borderColor: '#f59e0b',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                },
                {
                    label: isMobile ? 'ðŸ”´ 14%' : 'ðŸ”´ Agressivo (14% a.a.)',
                    data: dataAgressivo,
                    borderColor: '#ef4444',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: isMobile ? 10 : 15,
                        font: { size: isMobile ? 10 : 12, weight: '600' }
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: {
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: isMobile ? 6 : 12,
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000000) return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                            if (value >= 1000) return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                            return 'R$ ' + value.toFixed(0);
                        }
                    }
                }
            }
        }
    });
}

// =============================================================================
// GRÃFICO DE BARRAS - PatrimÃ´nio por MÃªs
// =============================================================================
const ctxBarras = document.getElementById('graficoBarras');

// âœ… CORRIGIDO: Validar elemento e dados
if (ctxBarras && historico.length > 0) {
    const ultimosMeses = historico.slice(-12);
    const labelsBarras = ultimosMeses.map((v, i) => `MÃªs ${historico.length - ultimosMeses.length + i + 1}`);

    new Chart(ctxBarras, {
        type: 'bar',
        data: {
            labels: labelsBarras,
            datasets: [{
                label: 'PatrimÃ´nio Acumulado',
                data: ultimosMeses,
                backgroundColor: 'rgba(37, 99, 235, 0.8)',
                borderColor: '#2563eb',
                borderWidth: 2,
                borderRadius: 8,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return 'R$ ' + context.parsed.y.toLocaleString('pt-BR', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false }
                },
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0, 0, 0, 0.05)' },
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000) return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                            return 'R$ ' + value.toFixed(0);
                        }
                    }
                }
            }
        }
    });
}

// =============================================================================
// GRÃFICO DE ROSCA - DiversificaÃ§Ã£o
// =============================================================================
{% if diversificacao %}
const ctxRosca = document.getElementById('graficoRosca');
const diversificacaoData = {{ diversificacao|safe }};

// âœ… CORRIGIDO: Validar elemento e dados
if (ctxRosca && Object.keys(diversificacaoData).length > 0) {
    const labelsDiversificacao = [];
    const valoresDiversificacao = [];
    const coresGrafico = [
        '#2563eb', '#10b981', '#f59e0b', '#8b5cf6', 
        '#ec4899', '#14b8a6', '#06b6d4', '#84cc16'
    ];

    let colorIndex = 0;
    for (const tipo in diversificacaoData) {
        labelsDiversificacao.push(tipo);
        valoresDiversificacao.push(diversificacaoData[tipo].percentual);
        colorIndex++;
    }

    new Chart(ctxRosca, {
        type: 'doughnut',
        data: {
            labels: labelsDiversificacao,
            datasets: [{
                data: valoresDiversificacao,
                backgroundColor: coresGrafico.slice(0, colorIndex),
                borderWidth: 3,
                borderColor: '#fff',
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: isMobile ? 10 : 12, weight: '600' },
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            return label + ': ' + value.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
}
{% endif %}
</script>
{% endblock %}