{% extends 'base.html' %}

{% block title %}Dashboard - Rumo1M{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="stat-card">
            <div class="stat-value">R$ {{ total|floatformat:2 }}</div>
            <div class="stat-label">Total Investido</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card">
            <div class="stat-value">{{ qtd_aportes }}</div>
            <div class="stat-label">Aportes Realizados</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card">
            <div class="stat-value">R$ {{ media_mensal|floatformat:2 }}</div>
            <div class="stat-label">M√©dia Mensal</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card">
            <div class="stat-value">R$ {{ maior_aporte|floatformat:2 }}</div>
            <div class="stat-label">Maior Aporte</div>
        </div>
    </div>
</div>

<!-- Pr√≥ximo Aporte Sugerido -->
{% if proximo_valor %}
    <div class="alert alert-info fs-5 mb-4">
        üí° Pr√≥ximo aporte sugerido: <b>R$ {{ proximo_valor|floatformat:2 }}</b>
    </div>
{% elif proximo_mensagem %}
    <div class="alert alert-warning fs-6 mb-4">
        <i class="bi bi-exclamation-triangle"></i> {{ proximo_mensagem }}
    </div>
{% endif %}

<!-- Badge de Progresso -->
<div class="badge-container mb-4">
    {% if badges.atual %}
    <div class="badge-card badge-alcancado animate-badge">
        <div class="badge-emoji">{{ badges.atual.emoji }}</div>
        <div class="badge-content">
            <h3 class="badge-titulo">{{ badges.atual.titulo }}</h3>
            <p class="badge-mensagem">{{ badges.atual.mensagem }}</p>
            <div class="badge-valor">R$ {{ badges.atual.valor|floatformat:0 }}</div>
        </div>
        <div class="badge-check">
            <i class="bi bi-check-circle-fill"></i>
        </div>
    </div>
    {% endif %}
    
    {% if not badges.proximo.alcancado %}
    <div class="badge-card badge-proximo">
        <div class="badge-emoji-gray">{{ badges.proximo.emoji }}</div>
        <div class="badge-content">
            <h3 class="badge-titulo-small">Pr√≥ximo Marco</h3>
            <h4 class="badge-titulo-proximo">{{ badges.proximo.titulo }}</h4>
            <p class="badge-mensagem-small">{{ badges.proximo.mensagem }}</p>
            <div class="badge-valor-proximo">R$ {{ badges.proximo.valor|floatformat:0 }}</div>
        </div>
        <div class="badge-progress">
            <div class="progress" style="height: 10px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-{{ badges.proximo.cor }}" 
                     role="progressbar" 
                     style="width: {{ badges.progresso }}%"
                     aria-valuenow="{{ badges.progresso }}" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                </div>
            </div>
            <div class="badge-progress-text">
                <span><strong>{{ badges.progresso }}%</strong> completo</span>
                <span class="text-muted">Faltam: <strong>R$ {{ badges.falta|floatformat:2 }}</strong></span>
            </div>
        </div>
    </div>
    {% else %}
    <div class="badge-card badge-final animate-badge">
        <div class="badge-emoji-huge">üëë</div>
        <div class="badge-content text-center">
            <h2 class="badge-titulo-huge">VOC√ä CONQUISTOU O MILH√ÉO!</h2>
            <p class="badge-mensagem-huge">Parab√©ns pela disciplina e determina√ß√£o! üéä</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Carteira de Investimentos -->
{% if tem_carteira %}
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title mb-4">
            <i class="bi bi-wallet2"></i> Minha Carteira
        </h5>
        
        <!-- KPIs da Carteira -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-value">R$ {{ total_investido_carteira|floatformat:2 }}</div>
                    <div class="stat-label">Investido</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-value">R$ {{ total_mercado_carteira|floatformat:2 }}</div>
                    <div class="stat-label">Valor Atual</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-value {% if lucro_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if lucro_total >= 0 %}+{% endif %}R$ {{ lucro_total|floatformat:2 }}
                    </div>
                    <div class="stat-label">Lucro/Preju√≠zo</div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="stat-card">
                    <div class="stat-value {% if rentabilidade >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {% if rentabilidade >= 0 %}+{% endif %}{{ rentabilidade|floatformat:2 }}%
                    </div>
                    <div class="stat-label">Rentabilidade</div>
                </div>
            </div>
        </div>

        <!-- Posi√ß√µes -->
        <h6 class="mb-3">Posi√ß√µes Atuais</h6>
        <div class="row g-3 mb-4">
            {% for chave, pos in carteira.items %}
            <div class="col-md-6 col-lg-4">
                <div class="card" style="border-left: 4px solid {% if pos.lucro_prejuizo >= 0 %}#10b981{% else %}#ef4444{% endif %};">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center mb-2">
                            {% if pos.logo %}
                            <img src="{{ pos.logo }}" alt="{{ pos.ticker }}" style="width: 45px; height: 45px; border-radius: 8px; margin-right: 12px; object-fit: contain; background: #f3f4f6; padding: 5px;">
                            {% else %}
                            <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 8px; margin-right: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                {{ pos.ticker|slice:":2"|default:"--" }}
                            </div>
                            {% endif %}
                            <div style="flex: 1; min-width: 0;">
                                <strong style="font-size: 1.1rem;">{{ pos.ticker|default:pos.nome|truncatechars:10 }}</strong><br>
                                <small class="text-muted" style="font-size: 0.75rem;">{{ pos.nome|truncatechars:20 }}</small>
                            </div>
                        </div>
                        <div class="mt-2" style="font-size: 0.85rem;">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Quantidade:</span>
                                <strong>{{ pos.quantidade|floatformat:2 }}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Pre√ßo M√©dio:</span>
                                <strong>R$ {{ pos.valor_medio|floatformat:2 }}</strong>
                            </div>
                            {% if pos.preco_atual %}
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Pre√ßo Atual:</span>
                                <strong>R$ {{ pos.preco_atual|floatformat:2 }}</strong>
                            </div>
                            {% endif %}
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Total Investido:</span>
                                <strong>R$ {{ pos.valor_total|floatformat:2 }}</strong>
                            </div>
                            {% if pos.valor_mercado %}
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Valor Atual:</span>
                                <strong>R$ {{ pos.valor_mercado|floatformat:2 }}</strong>
                            </div>
                            <div class="d-flex justify-content-between pt-2" style="border-top: 1px solid #e5e7eb;">
                                <span class="text-muted">L/P:</span>
                                <strong class="{% if pos.lucro_prejuizo >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if pos.lucro_prejuizo >= 0 %}+{% endif %}R$ {{ pos.lucro_prejuizo|floatformat:2 }} ({% if pos.rentabilidade >= 0 %}+{% endif %}{{ pos.rentabilidade|floatformat:1 }}%)
                                </strong>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Gr√°fico de Diversifica√ß√£o -->
        {% if diversificacao %}
        <h6 class="mb-3">Diversifica√ß√£o da Carteira</h6>
        <div style="max-height: 350px; position: relative;">
            <canvas id="graficoDiversificacao"></canvas>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Gr√°fico -->
<div class="card mb-4">
    <div class="card-body p-2 p-md-4">
        <h5 class="card-title mb-3 px-2">
            <i class="bi bi-graph-up"></i> Evolu√ß√£o Patrimonial
        </h5>
        <div class="chart-container">
            <canvas id="grafico"></canvas>
        </div>
    </div>
</div>

<!-- Lista de √öltimas Movimenta√ß√µes -->
<div class="card">
    <div class="card-body">
        <h5 class="card-title mb-4">
            <i class="bi bi-clock-history"></i> √öltimas Movimenta√ß√µes
        </h5>
        
        {% if ultimos_items %}
            {% for item in ultimos_items %}
            <div class="aporte-item">
                <div>
                    <div class="aporte-valor">
                        {% if item.is_aporte %}
                            üí∞ Aporte - R$ {{ item.valor|floatformat:2 }}
                        {% else %}
                            {% if item.tipo == 'Compra' %}üü¢{% else %}üî¥{% endif %} {{ item.tipo }} - R$ {{ item.valor|floatformat:2 }}
                        {% endif %}
                    </div>
                    <div class="aporte-data">
                        {{ item.data|date:"d/m/Y" }}
                        {% if item.descricao %}
                        <span class="text-muted">¬∑ {{ item.descricao }}</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    {% if item.is_aporte %}
                    <a href="{% url 'editar_aporte' item.id %}" class="btn btn-sm btn-outline-secondary me-1">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <a href="{% url 'deletar_aporte' item.id %}" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #d1d5db;"></i>
                <p class="text-muted mt-3">Nenhuma movimenta√ß√£o ainda</p>
                <p class="text-muted">Adicione seu primeiro investimento para come√ßar!</p>
            </div>
        {% endif %}
    </div>
</div>


<!-- Floating Action Button -->
<a href="{% url 'adicionar_aporte' %}" class="floating-btn">
    <i class="bi bi-plus-lg"></i>
</a>
{% endblock %}

{% block extra_js %}
<script>
// Dados do backend
const historico = {{ historico_acumulado|safe }};
const projecaoConservador = {{ projecao_conservador|safe }};
const projecaoModerado = {{ projecao_moderado|safe }};
const projecaoAgressivo = {{ projecao_agressivo|safe }};

console.log('Hist√≥rico:', historico);
console.log('Conservador:', projecaoConservador);
console.log('Moderado:', projecaoModerado);
console.log('Agressivo:', projecaoAgressivo);

// Preparar labels
const mesesHistorico = historico.length;
const mesesProjecao = projecaoConservador.length;
const totalMeses = mesesHistorico + mesesProjecao;

const labels = [];
for (let i = 1; i <= totalMeses; i++) {
    labels.push(i);
}

// Preparar datasets
// Hist√≥rico: valores reais acumulados at√© o √∫ltimo m√™s
const dataHistorico = [...historico].concat(Array(mesesProjecao).fill(null));

// Proje√ß√µes: null at√© o fim do hist√≥rico, depois os valores
const dataConservador = Array(mesesHistorico).fill(null).concat(projecaoConservador);
const dataModerado = Array(mesesHistorico).fill(null).concat(projecaoModerado);
const dataAgressivo = Array(mesesHistorico).fill(null).concat(projecaoAgressivo);

console.log('Data Hist√≥rico:', dataHistorico.filter(v => v !== null).length, 'valores');
console.log('Data Conservador:', dataConservador.filter(v => v !== null).length, 'valores');

// Criar gr√°fico
const ctx = document.getElementById('grafico');

// Configura√ß√µes responsivas
const isMobile = window.innerWidth < 768;
const config = {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            {
                label: isMobile ? 'üí∞ Acumulado' : 'üí∞ Patrim√¥nio Acumulado',
                data: dataHistorico,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: isMobile ? 3 : 4,
                tension: 0.3,
                fill: true,
                pointRadius: isMobile ? 0 : 5,
                pointHoverRadius: 6,
                pointBackgroundColor: '#10b981',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
            },
            {
                label: isMobile ? 'üü¢ 8%' : 'üü¢ Conservador (8% a.a.)',
                data: dataConservador,
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.05)',
                borderWidth: isMobile ? 2 : 3,
                borderDash: [10, 5],
                tension: 0.4,
                fill: false,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointBackgroundColor: '#22c55e',
            },
            {
                label: isMobile ? 'üü° 12%' : 'üü° Moderado (12% a.a.)',
                data: dataModerado,
                borderColor: '#eab308',
                backgroundColor: 'rgba(234, 179, 8, 0.05)',
                borderWidth: isMobile ? 2 : 3,
                borderDash: [10, 5],
                tension: 0.4,
                fill: false,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointBackgroundColor: '#eab308',
            },
            {
                label: isMobile ? 'üî¥ 14%' : 'üî¥ Agressivo (14% a.a.)',
                data: dataAgressivo,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.05)',
                borderWidth: isMobile ? 2 : 3,
                borderDash: [10, 5],
                tension: 0.4,
                fill: false,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointBackgroundColor: '#ef4444',
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    usePointStyle: true,
                    padding: isMobile ? 5 : 15,
                    font: {
                        size: isMobile ? 9 : 12,
                        weight: 'bold'
                    },
                    boxWidth: isMobile ? 8 : 12,
                    boxHeight: isMobile ? 8 : 12
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                padding: isMobile ? 8 : 12,
                cornerRadius: 10,
                titleFont: {
                    size: isMobile ? 12 : 14,
                    weight: 'bold'
                },
                bodyFont: {
                    size: isMobile ? 11 : 13
                },
                callbacks: {
                    title: function(context) {
                        const mes = context[0].label;
                        const anos = Math.floor(mes / 12);
                        const meses = mes % 12;
                        if (anos > 0) {
                            return `${anos}a ${meses}m`;
                        }
                        return `${meses} m√™s${meses !== 1 ? 'es' : ''}`;
                    },
                    label: function(context) {
                        if (context.parsed.y !== null) {
                            const valor = context.parsed.y.toLocaleString('pt-BR', {
                                style: 'currency',
                                currency: 'BRL',
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0
                            });
                            return isMobile ? valor : `${context.dataset.label}: ${valor}`;
                        }
                        return '';
                    }
                }
            }
        },
        scales: {
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    maxRotation: 0,
                    autoSkip: true,
                    maxTicksLimit: isMobile ? 4 : 12,
                    font: {
                        size: isMobile ? 8 : 11
                    },
                    callback: function(value) {
                        const mes = this.getLabelForValue(value);
                        if (mes % 12 === 0) {
                            return `${mes / 12}a`;
                        }
                        return '';
                    }
                }
            },
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                    callback: function(value) {
                        if (value >= 1000000) {
                            return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                        } else if (value >= 1000) {
                            return isMobile ? (value / 1000).toFixed(0) + 'k' : 'R$ ' + (value / 1000).toFixed(0) + 'k';
                        }
                        return isMobile ? value.toFixed(0) : 'R$ ' + value.toFixed(0);
                    },
                    font: {
                        size: isMobile ? 8 : 11
                    },
                    maxTicksLimit: isMobile ? 5 : 8
                }
            }
        },
        interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
        }
    }
};

new Chart(ctx, config);
</script>

{% if diversificacao %}
<script>
const ctxDiv = document.getElementById('graficoDiversificacao');
const diversificacaoData = {
    {% for tipo, data in diversificacao.items %}
    "{{ tipo }}": {{ data.percentual }},
    {% endfor %}
};

const labels = [];
const valores = [];
const coresGrafico = [
    '#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', 
    '#ec4899', '#14b8a6', '#06b6d4', '#84cc16', '#6b7280'
];

let i = 0;
for (const tipo in diversificacaoData) {
    labels.push(tipo);
    valores.push(diversificacaoData[tipo]);
}

new Chart(ctxDiv, {
    type: 'doughnut',
    data: {
        labels: labels,
        datasets: [{
            data: valores,
            backgroundColor: coresGrafico,
            borderWidth: 3,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    font: {
                        size: window.innerWidth < 768 ? 10 : 12,
                        weight: 'bold'
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}